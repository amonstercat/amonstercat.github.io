<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>打卡业务串讲 | Blog</title><meta name="keywords" content="Java,SpringBoot"><meta name="author" content="amonstercat"><meta name="copyright" content="amonstercat"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="打卡业务总览关键词 打卡业务中经常涉及到的关键词如下：     关键词 说明 示例    打卡规则 打卡规则主要是约束用户可打卡的方式：外勤打卡、内勤打卡；租户办公位置的gps或wifi信息(用来判断是否是有效打卡)；打卡动作的约束限制：是否需要附件、是否需要拍照等，目前打卡规则的配置是依附于考勤组规则配置页面    打卡渠道 打卡渠道是用来标识用户使用的是哪种渠道进行的打卡动作数据来源的主要渠道">
<meta property="og:type" content="article">
<meta property="og:title" content="打卡业务串讲">
<meta property="og:url" content="http://example.com/2023/11/15/%E6%89%93%E5%8D%A1%E4%B8%9A%E5%8A%A112-21-2/index.html">
<meta property="og:site_name" content="Blog">
<meta property="og:description" content="打卡业务总览关键词 打卡业务中经常涉及到的关键词如下：     关键词 说明 示例    打卡规则 打卡规则主要是约束用户可打卡的方式：外勤打卡、内勤打卡；租户办公位置的gps或wifi信息(用来判断是否是有效打卡)；打卡动作的约束限制：是否需要附件、是否需要拍照等，目前打卡规则的配置是依附于考勤组规则配置页面    打卡渠道 打卡渠道是用来标识用户使用的是哪种渠道进行的打卡动作数据来源的主要渠道">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/img/clockOn.png">
<meta property="article:published_time" content="2023-11-15T06:34:58.000Z">
<meta property="article:modified_time" content="2024-01-02T16:40:36.397Z">
<meta property="article:author" content="amonstercat">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="SpringBoot">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/clockOn.png"><link rel="shortcut icon" href="/img/boxertocat_octodex.jpg"><link rel="canonical" href="http://example.com/2023/11/15/%E6%89%93%E5%8D%A1%E4%B8%9A%E5%8A%A112-21-2/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '打卡业务串讲',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-01-03 00:40:36'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="themes/butterfly/source/css/font.css"><meta name="generator" content="Hexo 6.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/Monstercat.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">20</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">36</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">3</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-eye-low-vision"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/clockOn.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-eye-low-vision"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">打卡业务串讲<a class="post-edit-link" href="null_posts/打卡业务12-21-2.md" title="Edited on" target="_blank"><i class="fas fa-pencil-alt"></i></a></h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-11-15T06:34:58.000Z" title="Created 2023-11-15 14:34:58">2023-11-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-01-02T16:40:36.397Z" title="Updated 2024-01-03 00:40:36">2024-01-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%9E%E4%B9%A0/">实习</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">16.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>69min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="打卡业务串讲"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="打卡业务总览"><a href="#打卡业务总览" class="headerlink" title="打卡业务总览"></a>打卡业务总览</h1><h2 id="关键词"><a href="#关键词" class="headerlink" title="关键词"></a>关键词</h2><blockquote>
<p>打卡业务中经常涉及到的关键词如下：</p>
</blockquote>
<table>
<thead>
<tr>
<th><strong>关键词</strong></th>
<th><strong>说明</strong></th>
<th><strong>示例</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>打卡规则</strong></td>
<td><strong>打卡规则</strong>主要是约束用户可打卡的方式：外勤打卡、内勤打卡；租户办公位置的gps或wifi信息(用来判断是否是有效打卡)；打卡动作的约束限制：是否需要附件、是否需要拍照等，目前打卡规则的配置是依附于考勤组规则配置页面</td>
<td><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/34673482/1699585734637-6805c48e-3b90-429e-8130-93910bb37228.png" alt="img"></td>
</tr>
<tr>
<td><strong>打卡渠道</strong></td>
<td>打卡渠道是用来标识用户使用的是哪种渠道进行的打卡动作数据来源的主要渠道：拉取第三方： 企微、钉钉(钉钉打卡、钉钉签到)、飞书Moka打卡：moka移动端打卡考勤机打卡： 中控、天敏考勤机第三方主动上报： 使用openApi主动上报</td>
<td></td>
</tr>
<tr>
<td><strong>打卡成功提示</strong></td>
<td>打卡成功后，给用户发送打卡动作操作成功的提醒通知</td>
<td></td>
</tr>
<tr>
<td><strong>员工打卡提醒</strong></td>
<td>在上班时间范围和下班时间范围内主动发送通知，提醒用户进行打卡操作配置项：考勤组中设置上、下班的提醒时间(在班次前后多久)</td>
<td>例如设置的班次时间为<strong>9点~18点</strong> ：则上班打卡提醒：打卡前10分钟， 下班打卡提醒：下班后5分钟上班提醒通知发送时间：8点50分下班提醒通知发送时间：18点05分</td>
</tr>
<tr>
<td><strong>打卡方式</strong></td>
<td>内勤打卡：在租户办公点有效范围内的打卡行为属于内勤打卡外勤打卡：不在租户办公点有效范围内的打卡行为属于外勤打卡</td>
<td></td>
</tr>
<tr>
<td><strong>系统卡(免打卡)</strong></td>
<td>免打卡场景下，考勤核算在触发核算时给用户自动生成的打卡记录被称为系统卡</td>
<td>入、离职日免打卡请假免打卡外出免打卡出差免打卡入口：考勤组设置</td>
</tr>
<tr>
<td><strong>自动打卡</strong></td>
<td>为了提高用户打卡成功率，用户进入打卡页面时根据规则可能会主动触发一次自动打卡1. <strong>如果是有效上班打卡范围内，需要check范围内是否已经有过打卡记录，没有打卡记录的才会触发自动打卡</strong> 2. 如果在有效下班打卡范围内，进入页面就会触发一次自动打卡有效上班打卡范围： 标准上班打卡范围开始时间 ~ 弹性工作开始时间  有效下班打卡范围： 弹性工作结束时间 ~标准签退打卡范围结束时间</td>
<td>班次时间9点<del>18点，有效打卡范围 7点20点上班卡：用户在7点9点进入打卡页面，期间7点9点如果没有打卡记录，进入页面会触发自动打卡下班卡：用户在18点20点进入打卡页面，会触发自动打卡班次时间，需要考虑到弹性时间，比如允许晚到晚走30分钟，则上班卡自动打卡时间会变为7点</del>9点30(上班卡时间会考虑晚到晚走规则) ；上班打卡是8点半，则下班自动打卡开始时间为17点30</td>
</tr>
</tbody></table>
<h2 id="数据库表"><a href="#数据库表" class="headerlink" title="数据库表"></a>数据库表</h2><p>打卡通用规则表：</p>
<table>
<thead>
<tr>
<th align="left">表名</th>
<th align="left">说明</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="left">hcm_abs_attendance_rule_gps</td>
<td align="left">考勤规则中用于打卡的GPS位置表</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">hcm_abs_attendance_rule_wifi</td>
<td align="left">考勤规则中用于打卡的WiFi信息表</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">hcm_ding_user</td>
<td align="left">钉钉同步的用户表</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">hcm_abs_ding_talk_clock_record</td>
<td align="left">钉钉同步的打卡记录表</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">hcm_abs_clock_in_record</td>
<td align="left">所有来源汇总的打卡记录表</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">hcm_abs_moka_clock_record</td>
<td align="left">移动端打卡记录表</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">hcm_abs_sync_clock_record</td>
<td align="left">同步记录表</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">hcm_abs_ding_talk_sync_log</td>
<td align="left">钉钉同步操作的日志表</td>
<td align="left"></td>
</tr>
<tr>
<td align="left"><code>hcm_excel_template</code></td>
<td align="left">excel模板信息表</td>
<td align="left">公共的模块，不独属于clock，无需迁移</td>
</tr>
</tbody></table>
<p>三方打卡记录常用的数据库表：</p>
<p>常用数据库表：</p>
<p>以下和员工相关联的表都可以通过employeeId去查询对应的映射关系</p>
<table>
<thead>
<tr>
<th align="left">数据库表</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">hcm_ding_ent</td>
<td align="left">租户在钉钉和people的映射关系</td>
</tr>
<tr>
<td align="left">hcm_ding_user</td>
<td align="left">员工在钉钉和people的映射关系</td>
</tr>
<tr>
<td align="left">hcm_ding_talk_clock_record</td>
<td align="left">员工在钉钉打卡的原始记录</td>
</tr>
<tr>
<td align="left">hcm_wxin_ent</td>
<td align="left">员工在企业微信和people的映射关系</td>
</tr>
<tr>
<td align="left">hcm_wxin_user</td>
<td align="left">员工在企业微信和people的映射关系</td>
</tr>
<tr>
<td align="left">hcm_wxin_origin_clock_record</td>
<td align="left">员工在企业微信的原始记录</td>
</tr>
<tr>
<td align="left">hcm_lark_ent</td>
<td align="left">员工在飞书和people的映射关系</td>
</tr>
<tr>
<td align="left">hcm_lark_user</td>
<td align="left">员工在飞书和people的映射关系</td>
</tr>
<tr>
<td align="left">hcm_abs_lark_origin_clock_record</td>
<td align="left">员工在飞书的原始记录</td>
</tr>
</tbody></table>
<h2 id="关键流程图"><a href="#关键流程图" class="headerlink" title="关键流程图"></a>关键流程图</h2><p>1、<strong>整体业务逻辑</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311241612279.png" alt="image-20231124161236688" style="zoom:50%;" />





<p>2、移动端打卡</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311241614949.png" alt="image-20231124161431344"></p>
<p>3、手动导入打卡记录</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311241614269.png" alt="手动导入打卡记录"></p>
<p>4、同步钉钉打卡</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311241615688.png" alt="同步钉钉打卡"></p>
<p>5、企业微信打卡</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311241615151.png" alt="企业微信打卡流程图"></p>
<p>6、获取打卡记录</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311241616628.png" alt="获取打卡记录"></p>
<p>7、<strong>三方打卡记录交互流程</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311241622598.png" alt="image-20231124162252531"></p>
<h1 id="打卡数据同步"><a href="#打卡数据同步" class="headerlink" title="打卡数据同步"></a>打卡数据同步</h1><p>打卡数据同步的总体服务架构图如下所示：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/34673482/1699599809232-bf92b565-da77-4460-b4e9-52f1c2b52b69.png#averageHue=%23faf7f6&clientId=ud6df02a7-9e4b-4&from=ui&height=619&id=bGbit&originHeight=1542&originWidth=2044&originalType=binary&ratio=2&rotation=0&showTitle=false&size=195230&status=done&style=none&taskId=u7814840e-feb8-4791-9f5f-33c2141d61e&title=&width=820" alt="打卡流程.png"></p>
<h2 id="1、同步三方渠道打卡数据-exclamation"><a href="#1、同步三方渠道打卡数据-exclamation" class="headerlink" title="1、同步三方渠道打卡数据:exclamation:"></a>1、同步三方渠道打卡数据:exclamation:</h2><p>而<strong>针对三方渠道打卡的数据拉取环节</strong>，流程如下所示：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/34673482/1699600016465-594768ee-4f78-4fbb-8a1a-97521dfa93ba.png#averageHue=%23f9f9f9&clientId=ud6df02a7-9e4b-4&from=ui&id=TLb8w&originHeight=1395&originWidth=1312&originalType=binary&ratio=2&rotation=0&showTitle=false&size=200033&status=done&style=none&taskId=ub9f977de-df0f-4ab3-913d-3d222a8344e&title=" alt="打卡数据同步.drawio.png"></p>
<p>注意这里有几个要点:exclamation: :exclamation:</p>
<ol>
<li><p>transId的作用： 调用mobile获取打卡数据→ mobile返回打卡数据 是通过mq消息的方式触发的异步回调，由于三方人数+频次+时间区间的限制，一次调用可能会有多次的mq回调，transId的作用主要是用来识别某一批的拉取数据已经全部处理完成。构建一个transId为key,value为员工列表的set, 每次回调取出transId， 并删除回调数据中在set中的人员数据。如果transId的set为空，本次同步任务可以认为已结束</p>
</li>
<li><p>由于各个渠道目前对拉取频率限制不一样，并且考虑到一个渠道不能影响其他渠道的拉取，定时任务是分渠道进行的配置</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231147008.png"></p>
</li>
<li><p>各个渠道对历史是否已经处理过相同的打卡记录的判断方式是不一样的：如果三方有唯一性标识，则使用唯一性标识，如果没有则使用用户名+时间构成唯一性标识 ， 目前飞书用的是外部唯一标识 </p>
</li>
<li><p>中控考勤机由于在数据回写过程中的流程和三方渠道类似，所以也是采用的这种类似方式：将调用mobile的数据拉取接口更换为调用中控服务地址；数据拉取到后，将数据构造成mobile的打卡数据内容，发送到同topic下。后续卡数据处理流程一致</p>
</li>
</ol>
<p>问题：</p>
<ol>
<li>三方渠道的打卡时间在落打卡记录表时，被抹去了秒→ 导致的问题：用户如果在相同分钟，不同秒时间下，如果进行了多次打卡，在moka系统上，无法体现秒级别</li>
<li>三方渠道通常都会有自己的限流措施，这样就会有一个矛盾点：同步任务频率大(周期短)，用户的打卡数据就更实时，但是触发接口限流的几率就会很大→ 解决思路：如果三方渠道支持数据回调，需要接入回调。回调作为主，定时任务作为数据拉取的备用。</li>
</ol>
<hr>
<p>下面我们对着代码走一遍流程，看看是如何指定打卡渠道，并同步该渠道的数据：</p>
<p>代码入口在： <code>hcm-absence-clock</code>下的<code>SyncClockInRecordController.java</code>下：</p>
<p>1、在页面点击打卡数据同步时，可以选择多个渠道，比如数据来源选择 <strong>同步飞书：</strong><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/34673482/1699604849286-5e0b6599-75de-4aa9-92e5-a4ab92598f80.png#averageHue=%23b4e495&clientId=ued10d878-99c2-4&from=paste&height=774&id=Em8qv&originHeight=1548&originWidth=3238&originalType=binary&ratio=2&rotation=0&showTitle=false&size=458970&status=done&style=none&taskId=u4474ffad-8f30-4290-94b3-57a6141989d&title=&width=1619" alt="image.png"></p>
<p>可以看到  <code>clockInChannel</code>的<code>value</code>值为3 ，说明每一个<code>clockChannel</code>均关联一个特定的渠道，我们走入打卡的入口url（<code>/api/abs/clock/v1/channel/record/sync</code>）也可以看到：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;同步渠道打卡数据&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/sync&quot;)</span></span><br><span class="line">ResultDto&lt;Void&gt; <span class="title function_">sync</span><span class="params">(<span class="meta">@RequestBody</span> <span class="meta">@Validated</span> ApiSyncClockInDataParamDto param, <span class="meta">@ApiIgnore</span> CurrentUserDto currentUser)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (param.getStartDate().after(param.getEndDate())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CustomException</span>(ErrorCodeEnum.INVALID_PARAMS.getCode(), <span class="string">&quot;开始时间不能小于结束时间&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">entId</span> <span class="operator">=</span> currentUser.getEntId();</span><br><span class="line">    <span class="type">Long</span> <span class="variable">buId</span> <span class="operator">=</span> currentUser.getBuid();</span><br><span class="line">    <span class="type">SyncTypeEnum</span> <span class="variable">syncClockInChannel</span> <span class="operator">=</span> param.getClockInChannel();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//三方渠道记录在mobile中，所以这里只判断三方渠道的；中控内部方法有判断</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isThirdChannel</span> <span class="operator">=</span> isThirdChannel(syncClockInChannel);</span><br><span class="line">    <span class="keyword">if</span> (isThirdChannel) &#123;</span><br><span class="line">        List&lt;EntCheckInChannelDto&gt; entCheckInChannelDtoList = hcmAbsenceClockSyncServiceAdapter.list3rdCheckInEnt(entId, buId, <span class="literal">false</span>);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">notValidChannel</span> <span class="operator">=</span> !isValidThirdChannel(entCheckInChannelDtoList, syncClockInChannel);</span><br><span class="line">        <span class="keyword">if</span> (notValidChannel) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">syncClockInChannelDesc</span> <span class="operator">=</span> syncClockInChannel.getDesc();</span><br><span class="line">            log.error(<span class="string">&quot;企业未开通&quot;</span> + syncClockInChannelDesc + <span class="string">&quot;或未开启&quot;</span> + syncClockInChannelDesc + <span class="string">&quot;打卡&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ResultDto.success();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取指定渠道的处理方法,封装同步打卡数据的参数并传入</span></span><br><span class="line">    channelClockInThreadPool.execute(() -&gt;</span><br><span class="line">                                     syncClockInRecordFactory.getClockInRecordSyncReqService(param.getClockInChannel())</span><br><span class="line">                                     .syncChannelClockInData(SyncClockInDataArg.fromApiSyncParam(param, currentUser))</span><br><span class="line">                                    );</span><br><span class="line">    <span class="keyword">return</span> ResultDto.success();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>传入的<code>ApiSyncClockInDataParamDto</code>有一个内部属性<code>SyncTypeEnum</code>，该枚举类包含了所有渠道类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">SyncTypeEnum</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> com.moka.hcm.mobile.client.enums.ImCheckInChannelEnum</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    DINGDING(<span class="number">1</span>, <span class="string">&quot;钉钉打卡&quot;</span>, <span class="string">&quot;dingding&quot;</span>),</span><br><span class="line">    WEIXIN(<span class="number">2</span>, <span class="string">&quot;企业微信&quot;</span>, <span class="string">&quot;wechat&quot;</span>),</span><br><span class="line">    LARK(<span class="number">3</span>, <span class="string">&quot;飞书&quot;</span>, <span class="string">&quot;lark&quot;</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 考勤机相关</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    TEN_MOONS(<span class="number">4</span>, <span class="string">&quot;天敏考勤机&quot;</span>, <span class="string">&quot;10moons&quot;</span>),</span><br><span class="line">    ZKTECO_CLOUD(<span class="number">5</span>, <span class="string">&quot;中控云考勤机&quot;</span>, <span class="string">&quot;zktecocloud&quot;</span>),</span><br><span class="line">    DINGDING_CHECKIN(ImCheckInChannelEnum.DINGDING_CHECKIN.getChannel(),<span class="string">&quot;钉钉签到&quot;</span>,<span class="string">&quot;dingding_checkin&quot;</span>),</span><br><span class="line"></span><br><span class="line">    INTERFACE_SYNC(<span class="number">7</span>, <span class="string">&quot;接口同步&quot;</span>, <span class="string">&quot;openapi-interface&quot;</span>),</span><br><span class="line">    ZKTECO_CLIENT(<span class="number">8</span>,<span class="string">&quot;中控终端考勤机&quot;</span>,<span class="string">&quot;zkteco_client&quot;</span>),</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonValue</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> code;</span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line">    <span class="keyword">private</span> String value;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>注意这行代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">syncClockInRecordFactory.getClockInRecordSyncReqService(param.getClockInChannel())</span><br><span class="line">        .syncChannelClockInData(SyncClockInDataArg.fromApiSyncParam(param, currentUser))</span><br></pre></td></tr></table></figure>

<p>根据<code>param</code>中传入的<code>channel</code>值来获取对应的<code>service</code>（工厂模式的体现），然后调用该<code>service</code>下的<code>syncChannelClockInData</code>方法来处理</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/34673482/1699861289573-74fb1dd1-5f34-4e0f-ad35-082e23ee9b77.png#averageHue=%23f6f6f6&clientId=u9ef19e6c-d0f4-4&from=paste&height=601&id=u965d84c3&originHeight=1202&originWidth=2136&originalType=binary&ratio=2&rotation=0&showTitle=false&size=280767&status=done&style=none&taskId=u158e7f5a-bd37-492d-9eb3-c1cc72e9944&title=&width=1068" alt="image.png"></p>
<p>这里的数据同步就涉及到了多种同步方式(同步考勤机、定时任务定时拉取、PC端手动导入),下面先介绍定时任务同步方式</p>
<h3 id="1-1-定时任务-设置jobHandler"><a href="#1-1-定时任务-设置jobHandler" class="headerlink" title="1.1 定时任务 设置jobHandler"></a>1.1 定时任务 设置jobHandler</h3><p>对应xxl-job的界面为：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312061721014.png" alt="image-20231206172125908"></p>
<p>其中Cron表达式为： &#x3D;&#x3D;0 0&#x2F;10 * * * ?&#x3D;&#x3D;   </p>
<blockquote>
<p>这个 Cron 表达式 <code>0 0/10 * * * ?</code> 表示每隔10分钟执行一次任务。解析如下：</p>
<ul>
<li>第一个字段（秒）：0，表示在每分钟的第 0 秒执行。</li>
<li>第二个字段（分）：0&#x2F;10，表示每隔 10 分钟执行一次。</li>
<li>第三个字段（小时）：*，表示每小时都执行。</li>
<li>第四个字段（日）：*，表示每月都执行。</li>
<li>第五个字段（月）：*，表示每周都执行。</li>
<li>第六个字段（星期）：?，表示不指定星期。</li>
<li>第七个字段（年）：*，表示每年都执行。</li>
</ul>
<p>因此，这个表达式表示每隔10分钟执行一次任务，无论是哪一天，哪一个月，哪一年。</p>
</blockquote>
<p>再看两个例子：</p>
<p>例子1   &#x3D;&#x3D;0 30 1 * * ?&#x3D;&#x3D;	</p>
<p>这个 Cron 表达式 <code>0 30 1 * * ?</code> 表示在每天的凌晨1点30分执行一次任务。解析如下：</p>
<ul>
<li>第一个字段（秒）：0，表示在每分钟的第 0 秒执行。</li>
<li>第二个字段（分）：30，表示在每小时的第 30 分钟执行。</li>
<li>第三个字段（小时）：1，表示在每天的第 1 小时执行。</li>
<li>第四个字段（日）：*，表示每月都执行。</li>
<li>第五个字段（月）：*，表示每周都执行。</li>
<li>第六个字段（星期）：?，表示不指定星期。</li>
<li>第七个字段（年）：*，表示每年都执行。</li>
</ul>
<p>因此，这个表达式表示在每天凌晨1点30分执行一次任务，无论是哪一天，哪一个月，哪一年。</p>
<p>例子2   &#x3D;&#x3D;0 30 5,11,17,23 * * ?&#x3D;&#x3D;	</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312061730313.png" alt="image-20231206172959225"></p>
<p>这个 Cron 表达式 <code>0 30 5,11,17,23 * * ?</code> 表示在每天的凌晨5点30分、11点30分、下午5点30分、晚上11点30分各执行一次任务。解析如下：</p>
<ul>
<li>第一个字段（秒）：0，表示在每分钟的第 0 秒执行。</li>
<li>第二个字段（分）：30，表示在每小时的第 30 分钟执行。</li>
<li>第三个字段（小时）：5,11,17,23，表示在每天的第 5, 11, 17, 23 小时执行。</li>
<li>第四个字段（日）：*，表示每月都执行。</li>
<li>第五个字段（月）：*，表示每周都执行。</li>
<li>第六个字段（星期）：?，表示不指定星期。</li>
<li>第七个字段（年）：*，表示每年都执行。</li>
</ul>
<p>因此，这个表达式表示在每天的凌晨5点30分、11点30分、下午5点30分、晚上11点30分各执行一次任务。</p>
<p>在这个类中，<code>scheduleTaskRun</code> 方法就是执行定时任务的地方，方法内部通过调用 <code>clockInRecordTaskSyncService</code> 的 <code>syncChannelClockInData</code> 方法，传入构建好的参数对象，执行实际的同步操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@JobHandler(&quot;sync3rdClockInRecordJobHandler&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Sync3rdClockInRecordJobHandler</span> <span class="keyword">extends</span> <span class="title class_">LoopScheduleTaskImplementModule</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ClockInRecordTaskSyncServiceImpl clockInRecordTaskSyncService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">AUTO_CALCULATE_APOLLO_KEY</span> <span class="operator">=</span> <span class="string">&quot;sync-clock-record-auto-calculate&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">scheduleTaskRun</span><span class="params">(Long entId, Long buId, Map&lt;String, String&gt; otherParam)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;syncClockInRecordTask start....entId : &#123;&#125;, buId : &#123;&#125;, param : &#123;&#125;&quot;</span>,</span><br><span class="line">                 entId, buId, JacksonUtils.toJson(otherParam));</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">traceId</span> <span class="operator">=</span> UUID.randomUUID().toString().replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        MDC.put(CommonConstants.TRACE_ID, traceId);</span><br><span class="line"></span><br><span class="line">        <span class="type">SyncClockInDataArg</span> <span class="variable">arg</span> <span class="operator">=</span> buildDefaultArg();</span><br><span class="line">        arg.setEntId(entId);</span><br><span class="line">        arg.setBuId(buId);</span><br><span class="line">        <span class="type">SyncClockInRecordTaskParam</span> <span class="variable">param</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (MapUtils.isNotEmpty(otherParam)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                param = JacksonUtils.parse(JacksonUtils.toJson(otherParam), SyncClockInRecordTaskParam.class);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;syncClockInRecordTask task param fromJson failed, taskParam : &#123;&#125;&quot;</span>, JacksonUtils.toJson(otherParam));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">syncAllDay</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (param != <span class="literal">null</span>) &#123;</span><br><span class="line">            syncAllDay = param.getSyncAllDay();</span><br><span class="line">            <span class="type">Long</span> <span class="variable">entIdParam</span> <span class="operator">=</span> param.getEntId();</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">channel</span> <span class="operator">=</span> param.getChannel();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 指定了只同步固定的租户</span></span><br><span class="line">            <span class="keyword">if</span> (Objects.nonNull(entIdParam) &amp;&amp; BooleanUtils.isFalse(entId.equals(entIdParam))) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (Objects.nonNull(channel)) &#123;</span><br><span class="line">                <span class="type">SyncTypeEnum</span> <span class="variable">syncTypeEnum</span> <span class="operator">=</span> SyncTypeEnum.fromCode(channel);</span><br><span class="line">                <span class="keyword">if</span> (syncTypeEnum != <span class="literal">null</span>) &#123;</span><br><span class="line">                    arg.setClockInChannel(syncTypeEnum);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (BooleanUtils.isTrue(syncAllDay)) &#123;</span><br><span class="line">            <span class="type">DateTime</span> <span class="variable">now</span> <span class="operator">=</span> DateTime.now().withTime(<span class="number">8</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="type">Date</span> <span class="variable">endDate</span> <span class="operator">=</span> now.toDate();</span><br><span class="line">            <span class="type">Date</span> <span class="variable">startDate</span> <span class="operator">=</span> now.minusDays(<span class="number">1</span>).withTime(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>).toDate();</span><br><span class="line">            log.info(<span class="string">&quot;同步渠道打卡,同步时间:&#123;&#125;~&#123;&#125;&quot;</span>,</span><br><span class="line">                     DateFormatUtils.format(startDate, DatePattern.YMD), DateFormatUtils.format(endDate, DatePattern.YMD));</span><br><span class="line">            arg.setStartDate(startDate);</span><br><span class="line">            arg.setEndDate(endDate);</span><br><span class="line">            arg.setAutoCalculate(isAutoCalculate());</span><br><span class="line">            <span class="comment">// 同步全天数据需要和按时间段的任务区分开，不需要开启上批任务结束校验，防止任务重复导致拉取前一天的数据失败</span></span><br><span class="line">            arg.setWaitPreTaskDone(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        clockInRecordTaskSyncService.syncChannelClockInData(arg);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>







<p>根据下列代码可以看出：在xxl-job中会定时执行<code>ClockInRecordTaskSyncServiceImpl</code>中的方法<br>😲😲😲</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClockInRecordTaskSyncServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ClockInRecordSyncAllChannelReqService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> HcmAbsenceClockSyncServiceAdapter hcmAbsenceClockSyncServiceAdapter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SyncClockInRecordFactory factory;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//同步方法的入口处：</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">syncChannelClockInData</span><span class="params">(SyncClockInDataArg arg)</span> &#123;</span><br><span class="line">        Assert.notNull(arg, <span class="string">&quot;同步参数信息不能为空&quot;</span>);</span><br><span class="line">        Assert.notNull(arg.getEntId(), <span class="string">&quot;租户Id不能为空&quot;</span>);</span><br><span class="line">        Assert.notNull(arg.getBuId(), <span class="string">&quot;租户Id不能为空&quot;</span>);</span><br><span class="line">        <span class="type">Long</span> <span class="variable">entId</span> <span class="operator">=</span> arg.getEntId();</span><br><span class="line">        <span class="type">Long</span> <span class="variable">buId</span> <span class="operator">=</span> arg.getBuId();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//这里正常情况下入口只能是定时任务，可以使用缓存</span></span><br><span class="line">        List&lt;EntCheckInChannelDto&gt; entCheckInChannelDtoList = hcmAbsenceClockSyncServiceAdapter.list3rdCheckInEnt(entId, buId, <span class="literal">true</span>);<span class="comment">//获取企业支持的第三方打卡渠道列表</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(entCheckInChannelDtoList)) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;未查询到开启第同步三方打卡的租户 entId: &#123;&#125;&quot;</span>, entId);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">SyncTypeEnum</span> <span class="variable">syncTypeEnum</span> <span class="operator">=</span> arg.getClockInChannel();</span><br><span class="line">        <span class="keyword">for</span> (EntCheckInChannelDto entCheckInChannel : entCheckInChannelDtoList) &#123;</span><br><span class="line">            <span class="type">SyncTypeEnum</span> <span class="variable">channel</span> <span class="operator">=</span> entCheckInChannel.getChannel();</span><br><span class="line">            <span class="comment">// 如果指定的渠道，则只同步指定的渠道</span></span><br><span class="line">            <span class="keyword">if</span> (Objects.nonNull(syncTypeEnum) &amp;&amp; syncTypeEnum != channel) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//如果渠道相匹配，则根据打卡渠道类型 channel 获取相应的 ClockInRecordSyncReqService 实例</span></span><br><span class="line">            <span class="type">ClockInRecordSyncReqService</span> <span class="variable">clockInRecordSyncService</span> <span class="operator">=</span> factory.getClockInRecordSyncReqService(channel);</span><br><span class="line">            <span class="type">SyncClockInDataArg</span> <span class="variable">entArg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SyncClockInDataArg</span>();</span><br><span class="line">            BeanUtils.copyProperties(arg, entArg);</span><br><span class="line">            entArg.setClockInChannel(channel);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//调用 ClockInRecordSyncServiceDateWrapper 类的 syncChannelClockInData(entArg) 方法，将打卡数据同步给相应的打卡渠道服务</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ClockInRecordSyncServiceDateWrapper</span>(clockInRecordSyncService).syncChannelClockInData(entArg);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意<code>list3rdCheckInEnt()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;EntCheckInChannelDto&gt; <span class="title function_">list3rdCheckInEnt</span><span class="params">(Long entId, Long buId, <span class="type">boolean</span> loadFromCacheFirst)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">entCheckInChannelRedisKey</span> <span class="operator">=</span> buildEntCheckInChannelRedisKey(entId, buId);</span><br><span class="line">    List&lt;EntCheckInChannelDto&gt; entCheckInChannelDtoList = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (loadFromCacheFirst) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">queryEntCheckInChannelDtoListValueFromRedis</span> <span class="operator">=</span> redisTemplate.opsForValue().get(entCheckInChannelRedisKey);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(queryEntCheckInChannelDtoListValueFromRedis)) &#123;</span><br><span class="line">            entCheckInChannelDtoList = JacksonUtils.parse(queryEntCheckInChannelDtoListValueFromRedis, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;EntCheckInChannelDto&gt;&gt;() &#123;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> entCheckInChannelDtoList;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;EntCheckInChannel&gt; entCheckInChannelList = hcmAbsenceClockInService.list3rdCheckInEnt(entId, buId);</span><br><span class="line">    log.info(<span class="string">&quot;list3rdCheckInEnt resp:&#123;&#125;&quot;</span>, JacksonUtils.toJson(entCheckInChannelList));</span><br><span class="line">    entCheckInChannelDtoList = EntCheckInChannelDto.entCheckInChannel2Dto(entCheckInChannelList);<span class="comment">//将获取的 EntCheckInChannel 列表转换为 EntCheckInChannelDto 列表</span></span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">queryEntCheckInChannelDtoListValue</span> <span class="operator">=</span> JacksonUtils.toJson(entCheckInChannelDtoList);</span><br><span class="line">    redisTemplate.opsForValue().set(entCheckInChannelRedisKey, queryEntCheckInChannelDtoListValue, <span class="number">5</span>, TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> entCheckInChannelDtoList;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这里涉及到一个由<code>EntCheckInChannel</code>到<code>EntCheckInChannelDto</code>的类型转换问题：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * EntCheckInChannel 转化为  EntCheckInChannelDto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sources 原始数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> List&lt;EntCheckInChannelDto&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;EntCheckInChannelDto&gt; <span class="title function_">entCheckInChannel2Dto</span><span class="params">(List&lt;EntCheckInChannel&gt; sources)</span> &#123;</span><br><span class="line">    List&lt;EntCheckInChannelDto&gt; returnList = Lists.newArrayList();</span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isEmpty(sources)) &#123;</span><br><span class="line">        <span class="keyword">return</span> returnList;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (EntCheckInChannel entCheckInChannel : sources) &#123;</span><br><span class="line">        returnList.add(entCheckInChanel2Dto(entCheckInChannel));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> returnList;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * EntCheckInChannel 转化为  EntCheckInChannelDto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> source 原始数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> List&lt;EntCheckInChannelDto&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> EntCheckInChannelDto <span class="title function_">entCheckInChanel2Dto</span><span class="params">(EntCheckInChannel source)</span> &#123;</span><br><span class="line"><span class="type">SyncTypeEnum</span> <span class="variable">channel</span> <span class="operator">=</span> Optional.ofNullable(source.getImCheckInChannel()).map(imCheckInChannelEnum -&gt; SyncTypeEnum.fromCode(imCheckInChannelEnum.getChannel())).orElse(<span class="literal">null</span>);</span><br><span class="line"><span class="keyword">return</span> EntCheckInChannelDto.builder()</span><br><span class="line">.entId(source.getEntId())</span><br><span class="line">.buId(source.getBuId())</span><br><span class="line">.channel(channel)</span><br><span class="line">.build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码用到了<code>java8</code>中的<code>Optional</code>（开发中很常用）</p>
<p>其中，<code>Optional.ofNullable(source.getImCheckInChannel())</code>用来优雅处理<code>NullPointerException</code>问题；<br><code>ImCheckInChannelEnum.map(imCheckInChannelEnum -&gt; SyncTypeEnum.fromCode(imCheckInChannelEnum.getChannel()))</code> 在映射过程中，通过调用 imCheckInChannelEnum.getChannel() 方法获取打卡渠道的代码，然后使用 SyncTypeEnum.fromCode() 方法将代码转换为相应的 SyncTypeEnum 枚举值。如果转换成功，返回转换后的枚举值；<br>这是因为<code> ImCheckInChannelEnum</code>和 <code>SyncTypeEnum</code>两个枚举类对应的value不一致，需要进行同步 ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">SyncTypeEnum</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> com.moka.hcm.mobile.client.enums.ImCheckInChannelEnum</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    DINGDING(<span class="number">1</span>, <span class="string">&quot;钉钉打卡&quot;</span>, <span class="string">&quot;dingding&quot;</span>),</span><br><span class="line">    WEIXIN(<span class="number">2</span>, <span class="string">&quot;企业微信&quot;</span>, <span class="string">&quot;wechat&quot;</span>),</span><br><span class="line">    LARK(<span class="number">3</span>, <span class="string">&quot;飞书&quot;</span>, <span class="string">&quot;lark&quot;</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 考勤机相关</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    TEN_MOONS(<span class="number">4</span>, <span class="string">&quot;天敏考勤机&quot;</span>, <span class="string">&quot;10moons&quot;</span>),</span><br><span class="line">    ZKTECO_CLOUD(<span class="number">5</span>, <span class="string">&quot;中控云考勤机&quot;</span>, <span class="string">&quot;zktecocloud&quot;</span>),</span><br><span class="line">    DINGDING_CHECKIN(ImCheckInChannelEnum.DINGDING_CHECKIN.getChannel(),<span class="string">&quot;钉钉签到&quot;</span>,<span class="string">&quot;dingding_checkin&quot;</span>),</span><br><span class="line"></span><br><span class="line">    INTERFACE_SYNC(<span class="number">7</span>, <span class="string">&quot;接口同步&quot;</span>, <span class="string">&quot;openapi-interface&quot;</span>),</span><br><span class="line">    ZKTECO_CLIENT(<span class="number">8</span>,<span class="string">&quot;中控终端考勤机&quot;</span>,<span class="string">&quot;zkteco_client&quot;</span>),</span><br><span class="line">    ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">ImCheckInChannelEnum</span> &#123;</span><br><span class="line">    DINGDING_CHECKIN(ImTypeEnum.DINGDING.getCode(), <span class="string">&quot;钉钉签到&quot;</span>, <span class="number">6</span>),</span><br><span class="line">    DINGDING(ImTypeEnum.DINGDING.getCode(), <span class="string">&quot;钉钉打卡&quot;</span>, <span class="number">1</span>),</span><br><span class="line">    WEIXIN(ImTypeEnum.WEIXIN.getCode(), <span class="string">&quot;企业微信&quot;</span>, <span class="number">2</span>),</span><br><span class="line">    LARK(ImTypeEnum.LARK.getCode(), <span class="string">&quot;飞书打卡&quot;</span>, <span class="number">3</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>然后回到核心同步的逻辑处：<br><code>new ClockInRecordSyncServiceDateWrapper(clockInRecordSyncService).syncChannelClockInData(entArg);</code>   这里需要注意 实际调用的方法是<code>AbstractChannelClockInRecordSyncService</code>中的<code>syncChannelClockInData</code>方法：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/34673482/1699863257445-143bbceb-ec12-4f72-aef7-3400236e67b3.png#averageHue=%23f2f1f1&clientId=u9ef19e6c-d0f4-4&from=paste&height=554&id=u0b5f44ff&originHeight=1108&originWidth=2556&originalType=binary&ratio=2&rotation=0&showTitle=false&size=438677&status=done&style=none&taskId=u13b18a6a-80dd-43af-83c8-d12d2bdf978&title=&width=1278" alt="image.png"></p>
<blockquote>
<p>这是为什么❓❓</p>
</blockquote>
<p>该抽象类中的<code>syncChannelClockInData</code>方法实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">syncChannelClockInData</span><span class="params">(SyncClockInDataArg arg)</span> &#123;</span><br><span class="line">log.info(<span class="string">&quot;开始执行同步打卡数据任务,请求参数:&#123;&#125;&quot;</span>, JacksonUtils.toJson(arg));</span><br><span class="line">arg.check();</span><br><span class="line"><span class="type">Long</span> <span class="variable">entId</span> <span class="operator">=</span> arg.getEntId();</span><br><span class="line"><span class="type">Long</span> <span class="variable">buId</span> <span class="operator">=</span> arg.getBuId();</span><br><span class="line"><span class="type">SyncTypeEnum</span> <span class="variable">syncTypeEnum</span> <span class="operator">=</span> arg.getClockInChannel();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//屏蔽黑名单租户</span></span><br><span class="line">List&lt;Long&gt; blackEntList = getBlackEntList();</span><br><span class="line"><span class="keyword">if</span> (blackEntList.contains(entId)) &#123;</span><br><span class="line">    log.warn(<span class="string">&quot;企业不允许进行打卡数据同步, entId:&quot;</span> + entId + <span class="string">&quot;, blackEntList:&quot;</span> + JacksonUtils.toJson(blackEntList));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">List&lt;SyncTypeEnum&gt; blackChannelList = getBlackChannelList();</span><br><span class="line"><span class="keyword">if</span> (blackChannelList.contains(syncTypeEnum)) &#123;</span><br><span class="line">    log.warn(<span class="string">&quot;不允许当前渠道的打卡数据同步, entId:&quot;</span> + entId + <span class="string">&quot;, channel:&quot;</span> + syncTypeEnum + <span class="string">&quot;, blackChannelList:&quot;</span> + JacksonUtils.toJson(blackChannelList));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">Date</span> <span class="variable">syncStartDate</span> <span class="operator">=</span> arg.getStartDate();</span><br><span class="line"><span class="type">Date</span> <span class="variable">syncEndDate</span> <span class="operator">=</span> DateUtil.getMaxTimeOfDay(arg.getEndDate());</span><br><span class="line"></span><br><span class="line"><span class="type">EntDto</span> <span class="variable">entDto</span> <span class="operator">=</span> EntDto.builder().entId(entId).buId(buId).build();</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过租户信息获取该租户下的全量员工信息</span></span><br><span class="line">List&lt;EmployeeInfoDto&gt; employeeInfoDtoList = hrJobInfoAdapter.getEmployeesByEnt(entDto, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//过滤掉同步日期前多少天离职的员工，不用再拉取这些员工的数据</span></span><br><span class="line">List&lt;Long&gt; employeeIds = SyncEmployeeFilter.filterValidEmployee(entId,buId,employeeInfoDtoList, syncStartDate);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (CollectionUtils.isEmpty(employeeIds)) &#123;</span><br><span class="line">    log.info(<span class="string">&quot;未查询到 ent:&#123;&#125;, buId:&#123;&#125; 员工信息,&#123;&#125;打卡记录同步结束.&quot;</span>, entId, buId, getChannelDesc());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 校验上次任务执行状态</span></span><br><span class="line"><span class="keyword">if</span> (BooleanUtils.isTrue(arg.getWaitPreTaskDone()) &amp;&amp; !preTaskDone(entId, buId, arg.getClockInChannel(), employeeIds)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//将同步日期范围拆分为多个时间段</span></span><br><span class="line">List&lt;DateScope&gt; dateScopes = DateUtil.partition(syncStartDate, syncEndDate, getMaxSyncDay());</span><br><span class="line">log.info(<span class="string">&quot;时间拆分后为：&#123;&#125;&quot;</span>, JacksonUtils.toJson(dateScopes));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//生成transId</span></span><br><span class="line"><span class="type">String</span> <span class="variable">transId</span> <span class="operator">=</span> arg.buildTransId();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 保存 log</span></span><br><span class="line">syncLogService.save(buildDingTalkSyncLog(arg, <span class="keyword">new</span> <span class="title class_">Date</span>(), transId));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 针对每个时间段，构建同步打卡记录的请求对象，并使用适配器对象 </span></span><br><span class="line"><span class="comment">* hcmAbsenceClockSyncServiceAdapter 异步调用打卡记录的同步方法</span></span><br><span class="line"><span class="comment">* asyncPull3rdCheckInRecord()</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">for</span> (DateScope dateScope : dateScopes) &#123;</span><br><span class="line">    <span class="type">SyncChannelClockRecordReqDto</span> <span class="variable">syncChannelClockRecordReqDto</span> <span class="operator">=</span> buildSyncChannelClockRecordReqDto(entId, buId, employeeIds, transId, dateScope);</span><br><span class="line">    log.info(<span class="string">&quot;asyncPull3rdCheckInRecord ,syncChannelClockRecordReqDto:&#123;&#125;&quot;</span>, syncChannelClockRecordReqDto);</span><br><span class="line">    hcmAbsenceClockSyncServiceAdapter.asyncPull3rdCheckInRecord(syncChannelClockRecordReqDto);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>真正执行打卡数据同步的逻辑在 <code>syncChannelClockInData</code>() 方法中，通过调用适配器对象的方法进行异步打卡记录同步：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HcmAbsenceClockSyncServiceAdapterImpl</span> <span class="keyword">implements</span> <span class="title class_">HcmAbsenceClockSyncServiceAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">asyncPull3rdCheckInRecord</span><span class="params">(SyncChannelClockRecordReqDto syncChannelClockRecordReqDto)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取打卡同步日期区间</span></span><br><span class="line">        <span class="type">DateScope</span> <span class="variable">syncDateScope</span> <span class="operator">=</span> syncChannelClockRecordReqDto.getDateScope(); </span><br><span class="line">      </span><br><span class="line">        <span class="type">SyncTypeEnum</span> <span class="variable">syncChannelType</span> <span class="operator">=</span> syncChannelClockRecordReqDto.getChannel();</span><br><span class="line">        <span class="type">Long</span> <span class="variable">entId</span> <span class="operator">=</span> syncChannelClockRecordReqDto.getEntId();</span><br><span class="line">        <span class="type">Long</span> <span class="variable">buId</span> <span class="operator">=</span> syncChannelClockRecordReqDto.getBuId();</span><br><span class="line">        <span class="type">PullChannelCheckInRecordReq</span> <span class="variable">pullChannelCheckInRecordReq</span> <span class="operator">=</span> PullChannelCheckInRecordReq.builder()</span><br><span class="line">        .entId(entId)</span><br><span class="line">        .buId(buId)</span><br><span class="line">        .startDate(syncDateScope.getStartDate())</span><br><span class="line">        .endDate(syncDateScope.getEndDate())</span><br><span class="line">        .employeeIds(syncChannelClockRecordReqDto.getEmployeeIds())</span><br><span class="line">        .checkInChannel(ImCheckInChannelEnum.getEnumByChannelCode(syncChannelType.getCode()))</span><br><span class="line">        .transId(syncChannelClockRecordReqDto.getTransId())</span><br><span class="line">        .build();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;asyncPull3rdCheckInRecord req:&#123;&#125;&quot;</span>, JacksonUtils.toJson(pullChannelCheckInRecordReq));</span><br><span class="line">            <span class="type">BaseResult</span> <span class="variable">result</span> <span class="operator">=</span> hcmAbsenceClockInService.asyncPull3rdCheckInRecord(pullChannelCheckInRecordReq);</span><br><span class="line">            <span class="keyword">if</span> (!result.isSuccess()) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;asyncPull3rdCheckInRecord failed, result:&#123;&#125;&quot;</span>, JacksonUtils.toJson(result));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;同步&quot;</span> + syncChannelType.getDesc() + <span class="string">&quot;打卡数据异常,ent:&#123;&#125;, buId:&#123;&#125;.&quot;</span>, entId, buId, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<hr>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231421866.png" alt="image-20231123141647483"></p>
<p>&#x3D;&#x3D;只关注核心逻辑&#x3D;&#x3D;： </p>
<p><code>BaseResult result = hcmAbsenceClockInService.asyncPull3rdCheckInRecord(pullChannelCheckInRecordReq);</code><br>会发现：</p>
<p>1、该方法首先会调用 <strong>hcm-mobile-client 模块</strong>下的<code>pull3rdCheckInRecord</code>方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231427658.png" alt="image-20231123142739396"></p>
<p>2、然后通过<code>openFeign</code>远程调用 &#x3D;&#x3D;hcm-mobile&#x3D;&#x3D;模块下的	：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231425993.png" alt="image-20231123142528733"></p>
<p>其入口url在 <code>hcm——mobile</code>下：</p>
<blockquote>
<p>&#x2F;client&#x2F;api&#x2F;mobile&#x2F;absence&#x2F;pull3rdCheckInRecord</p>
</blockquote>
<p>3、 <code>hcm-mobile</code>下对应的<code>controller</code>及<code>service</code>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 拉取三方打卡数据</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pullChannelCheckInRecordReq 拉取</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 拼装后的第三方打卡数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(value = &quot;/absence/pull3rdCheckInRecord&quot;, produces = &quot;application/json&quot;)</span></span><br><span class="line">BaseResult <span class="title function_">pull3rdCheckInRecord</span><span class="params">(<span class="meta">@RequestBody</span> PullChannelCheckInRecordReq pullChannelCheckInRecordReq,CurrentUserDto currentUserDto)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> absenceService.pull3rdCheckInRecord(pullChannelCheckInRecordReq,currentUserDto);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * HcmAbsenceServiceImpl.pull3rdCheckInRecord的方法实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> BaseResult <span class="title function_">pull3rdCheckInRecord</span><span class="params">(PullChannelCheckInRecordReq req, CurrentUserDto currentUserDto)</span> &#123;</span><br><span class="line">  <span class="comment">//获取request中打卡渠道对应的枚举类型</span></span><br><span class="line">  <span class="type">ImCheckInChannelEnum</span> <span class="variable">imCheckInChannel</span> <span class="operator">=</span> req.getCheckInChannel();</span><br><span class="line">  <span class="keyword">if</span> (Objects.isNull(imCheckInChannel)) &#123;</span><br><span class="line">    <span class="keyword">return</span> BaseResult.buildResult(ErrorCodeEnum.SYS_INVALID_PARAMS);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//工厂模式创建对应打卡渠道的service——根据不同的 ImTypeEnum 创建相应的 HcmImEntService 实例</span></span><br><span class="line">  HcmImEntService&lt;?&gt; hcmImEntService = HcmMobileEntServiceFactory.createHcmImEntService(imCheckInChannel.getImType());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据租户查询对应渠道的打卡数据同步是否开启</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  List&lt;EntCheckInChannel&gt; absenceModes = hcmImEntService.getAbsenceModeNew(req.getEntId(), req.getBuId());</span><br><span class="line">  log.info(<span class="string">&quot;search entId -&#123;&#125; buId - &#123;&#125; ent check in channel :&#123;&#125;&quot;</span>, req.getEntId(), req.getBuId(), JsonUtils.toJsonString(absenceModes));</span><br><span class="line">  <span class="keyword">if</span> (CollectionUtils.isEmpty(absenceModes)) &#123;</span><br><span class="line">    log.info(<span class="string">&quot;打卡数据同步开关未开启：ent:&#123;&#125;,channel:&#123;&#125;&quot;</span>, req.getEntId(), JacksonUtils.toJson(req.getCheckInChannel()));</span><br><span class="line">    <span class="keyword">return</span> BaseResult.buildResult(ErrorCodeEnum.PUNCH_DATA_SWITCH_CLOSE);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">boolean</span> <span class="variable">switchFlag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">for</span> (EntCheckInChannel absenceMode : absenceModes) &#123;</span><br><span class="line">    <span class="keyword">if</span> (absenceMode.getImCheckInChannel().equals(imCheckInChannel)) &#123;</span><br><span class="line">      switchFlag = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!switchFlag) &#123;</span><br><span class="line">    log.info(<span class="string">&quot;打卡数据同步开关未开启：ent:&#123;&#125;,channel:&#123;&#125;&quot;</span>, req.getEntId(), JacksonUtils.toJson(req.getCheckInChannel()));</span><br><span class="line">    <span class="keyword">return</span> BaseResult.buildResult(ErrorCodeEnum.PUNCH_DATA_SWITCH_CLOSE);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//又是工厂模式的体现</span></span><br><span class="line">  <span class="type">HcmMobileAbsenceService</span> <span class="variable">hcmIntegrationService</span> <span class="operator">=</span> HcmMobileAbsenceServiceFactory.createHcmMobileAbsenceService(imCheckInChannel);</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  hcmIntegrationService.pullAbsenceData(req, currentUserDto); <span class="comment">//核心逻辑</span></span><br><span class="line">  <span class="keyword">return</span> BaseResult.buildResult(ErrorCodeEnum.SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<blockquote>
<p>注意这里根据不同的打卡渠道，需要查询&#x3D;&#x3D;对应租户是否开启了对应渠道的打卡数据同步方式 :exclamation::exclamation:&#x3D;&#x3D;</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231440771.png" alt="image-20231123144027523"></p>
<p>以钉钉、飞书为例：</p>
<ul>
<li><p><input disabled="" type="checkbox"> 
lark:<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231443521.png" alt="image-20231123144308274"></p>
</li>
<li><p><input disabled="" type="checkbox"> 
DingDing:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231444977.png" alt="image-20231123144413716"></p>
</li>
<li><p><input disabled="" type="checkbox"> 
WeiXin: 同理</p>
</li>
</ul>
<h3 id="1-2-主动Pull-拉取第三方渠道"><a href="#1-2-主动Pull-拉取第三方渠道" class="headerlink" title="1.2 主动Pull 拉取第三方渠道"></a>1.2 主动Pull 拉取第三方渠道</h3><p> <code>hcmIntegrationService.pullAbsenceData(req, currentUserDto);</code> </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231454077.png" alt="image-20231123145427820"></p>
<h4 id="拉取飞书打卡"><a href="#拉取飞书打卡" class="headerlink" title="拉取飞书打卡"></a>拉取飞书打卡</h4><p>有几点注意事项：</p>
<ul>
<li><p><code>HcmLarkEnt</code>表示飞书中的企业与HCM租户映射关系类<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231504505.png" alt="image-20231123150417239" style="zoom: 40%;" /></p>
</li>
<li><p>在执行数据拉取时使用了自定义线程池（阻塞队列容量为10000）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 线程池</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ThreadPoolExecutor</span> <span class="variable">PUNCH_DATA_SYNC_EXECUTOR</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LogThreadLocalThreadPoolExecutor</span>(<span class="number">20</span>, <span class="number">20</span>, <span class="number">60</span>, TimeUnit.SECONDS,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">10000</span>), <span class="keyword">new</span> <span class="title class_">NamedThreadFactory</span>(<span class="string">&quot;async_pull_punch_data&quot;</span>) &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(Runnable r)</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="built_in">super</span>.newThread(r);</span><br><span class="line">        thread.setUncaughtExceptionHandler((t, e) -&gt; log.error(<span class="string">&quot;线程 &#123;&#125; 遇到未捕获的异常&quot;</span>, t.getName(), e));</span><br><span class="line">        <span class="keyword">return</span> thread;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, (r, executor) -&gt; log.error(<span class="string">&quot;线程 &#123;&#125; 处理失败&quot;</span>, r));</span><br></pre></td></tr></table></figure></li>
</ul>
<p>然后我们再来看逻辑代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pullAbsenceData</span><span class="params">(PullChannelCheckInRecordReq req, CurrentUserDto userDto)</span> &#123;</span><br><span class="line">    <span class="comment">// log.info(&quot;begin pull absence data param：&#123;&#125;&quot;, JsonUtils.toJsonString(req));</span></span><br><span class="line"></span><br><span class="line">    <span class="type">Long</span> <span class="variable">entId</span> <span class="operator">=</span> req.getEntId();</span><br><span class="line">    <span class="type">Long</span> <span class="variable">buId</span> <span class="operator">=</span> req.getBuId();</span><br><span class="line">    <span class="type">HcmLarkEnt</span> <span class="variable">hcmLarkEnt</span> <span class="operator">=</span> hcmLarkEntDao.findByEntId(entId, buId);</span><br><span class="line">    <span class="type">String</span> <span class="variable">corpId</span> <span class="operator">=</span> hcmLarkEnt.getCorpId();</span><br><span class="line">    <span class="comment">// log.info(&quot;batchNumber begin async : &#123;&#125; entId :&#123;&#125; buId :&#123;&#125;&quot;, batchNumber, entId, buId);</span></span><br><span class="line">    List&lt;Long&gt; employeeIds = req.getEmployeeIds();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//飞书开放平台规定每次调用最多50个，生成一个包含多个子列表（元素数量为50）的列表 lists</span></span><br><span class="line">    List&lt;List&lt;Long&gt;&gt; lists = ListUtils.partition(employeeIds, ImIntegrationConstants.LARK_MAX_COUNT_PULL);</span><br><span class="line">    <span class="keyword">for</span> (List&lt;Long&gt; list : lists) &#123;</span><br><span class="line">        PUNCH_DATA_SYNC_EXECUTOR.execute(() -&gt; &#123;</span><br><span class="line">            asyncPullPunchData(list, req, corpId);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>进入到 **asyncPullPunchData **方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">asyncPullPunchData</span><span class="params">(List&lt;Long&gt; list, PullChannelCheckInRecordReq req, String corpId)</span> &#123;</span><br><span class="line">    Long entId= req.getEntId();</span><br><span class="line">    accessLimitService.larkAbsenceAcquireByEnt(req.getEntId()); <span class="comment">//外部接口调用限流</span></span><br><span class="line">    List&lt;HcmLarkUser&gt; hcmLarkUsers = hcmLarkUserDao.findByEmployeeIds(req.getEntId(), req.getBuId(), corpId, list);</span><br><span class="line">    Map&lt;Long, String&gt; employeeIdUserIdMap = hcmLarkUsers.parallelStream()</span><br><span class="line">            .filter(hcmLarkUser -&gt; DataStatusEnum.ENABLE.getStatus() == hcmLarkUser.getBindStatus())</span><br><span class="line">            .collect(Collectors.toMap(HcmLarkUser::getEmployeeId, HcmLarkUser::getUserid, (v1, v2) -&gt; v2));</span><br><span class="line">    List&lt;ChannelCheckInDataRes&gt; resList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; userIdList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(employeeIdUserIdMap.values());</span><br><span class="line">    List&lt;LarkAttendanceUserFlowRespVO&gt; records = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (!employeeIdUserIdMap.isEmpty()) &#123;</span><br><span class="line">        records = getPunchRecord(userIdList, req, corpId); <span class="comment">//获取飞书打卡记录</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    Map&lt;String, List&lt;LarkAttendanceUserFlowRespVO&gt;&gt; larkClockRecordMap = records.stream().collect(Collectors.groupingBy(item -&gt; item.getUserId()));<span class="comment">//按用户ID分组打卡记录：</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!larkClockRecordMap.isEmpty()) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;查询到的飞书打卡数据结果集 ：&#123;&#125;&quot;</span>, JsonUtils.toJsonString(larkClockRecordMap));</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 遍历员工ID列表，构建打卡数据结果</span></span><br><span class="line">    <span class="keyword">for</span> (Long employeeId : list) &#123;</span><br><span class="line">        <span class="type">ChannelCheckInDataRes</span> <span class="variable">channelCheckInDataRes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChannelCheckInDataRes</span>();</span><br><span class="line">        channelCheckInDataRes.setChannel(ImCheckInChannelEnum.LARK);</span><br><span class="line">        channelCheckInDataRes.setBuId(req.getBuId());</span><br><span class="line">        channelCheckInDataRes.setEntId(req.getEntId());</span><br><span class="line">        channelCheckInDataRes.setEmployeeId(employeeId);</span><br><span class="line">        channelCheckInDataRes.setTransId(req.getTransId());</span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> employeeIdUserIdMap.get(employeeId);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(userId) &amp;&amp; larkClockRecordMap.containsKey(userId)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (LarkAttendanceUserFlowRespVO larkClockRecord : larkClockRecordMap.get(userId)) &#123;</span><br><span class="line">                <span class="type">ChannelCheckInDataRes</span> <span class="variable">channelCheckInDataResSuccess</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChannelCheckInDataRes</span>();</span><br><span class="line">                BeanUtils.copyProperties(channelCheckInDataRes, channelCheckInDataResSuccess);</span><br><span class="line">                channelCheckInDataResSuccess.setOutsideClock(larkClockRecord.getIsField());</span><br><span class="line">                channelCheckInDataResSuccess.setOutsideRemark(larkClockRecord.getComment());</span><br><span class="line">                channelCheckInDataResSuccess.setCheckInSource(Integer.toString(larkClockRecord.getType()));</span><br><span class="line">                channelCheckInDataResSuccess.setCheckInTime(Long.valueOf(larkClockRecord.getCheckTime()));</span><br><span class="line">                channelCheckInDataResSuccess.setDeviceId(larkClockRecord.getDeviceId());</span><br><span class="line">                channelCheckInDataResSuccess.setLocationDetail(larkClockRecord.getLocationName());</span><br><span class="line">                channelCheckInDataResSuccess.setOriginData(JacksonUtils.toJson(larkClockRecord));</span><br><span class="line">                channelCheckInDataResSuccess.setRecordId(larkClockRecord.getRecordId());</span><br><span class="line">                channelCheckInDataResSuccess.setVerify(Objects.toString(larkClockRecord.getType(), <span class="literal">null</span>));</span><br><span class="line">                <span class="keyword">if</span> (CollectionUtils.isNotEmpty(larkClockRecord.getPhotoUrls())) &#123;</span><br><span class="line">                    channelCheckInDataResSuccess.setImg(larkClockRecord.getPhotoUrls().get(<span class="number">0</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                resList.add(channelCheckInDataResSuccess);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        resList.add(channelCheckInDataRes);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    absenceMsgProducer.pushMsg(resList,entId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>流程如下：</p>
<ol>
<li><p>从请求参数 <code>req</code> 中获取企业ID</p>
</li>
<li><p>对飞书打卡数据拉取的访问限制:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231515531.png" alt="image-20231123151536227"></p>
<ul>
<li>使用企业ID构建了一个用于存储在 Redis 中的键</li>
<li>使用 <code>redisLimitTemplate</code> 初始化一个令牌桶限流器，每秒生成 <code>40 - LIMIT_BUFFER</code> 个令牌，即每秒填充 <code>40 - LIMIT_BUFFER</code> 个令牌到令牌桶中 ，<strong>这里使用了<code>RRateLimiter</code>分布式限流器</strong>，相关文章链接如下：<ul>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000043472098">谈谈限流算法，以及Redisson实现</a></li>
<li><a target="_blank" rel="noopener" href="https://open.dingtalk.com/document/orgapp/how-to-process-api-throttling-on-the-dingtalk-server">如何处理钉钉服务端API限流</a></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>查询这些飞书用户对应在hcm中的租户信息</strong>，<strong>构建员工ID到飞书用户ID的映射</strong></p>
</li>
<li><p>&#x3D;&#x3D;获取飞书打卡记录: getPunchRecord()方法&#x3D;&#x3D;</p>
</li>
<li><p><strong>按用户ID分组打卡记录，遍历员工ID列表，构建打卡数据结果，构建打卡数据结果列表</strong></p>
</li>
<li><p>构建好的打卡数据结果通过<code>kafka</code>发送异步消息  <a href="#consumer-batch">消费者批量消费</a></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231552151.png" alt="image-20231123155217105" style="zoom:45%;" /></li>
</ol>
<p><strong>针对其中的第四步</strong>，获取飞书打卡记录这里，方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;LarkAttendanceUserFlowRespVO&gt; <span class="title function_">getPunchRecord</span><span class="params">(List&lt;String&gt; list, PullChannelCheckInRecordReq req, String corpId)</span> &#123;</span><br><span class="line">    <span class="type">Date</span> <span class="variable">startDate</span> <span class="operator">=</span> req.getStartDate();</span><br><span class="line">    <span class="type">Date</span> <span class="variable">endDate</span> <span class="operator">=</span> req.getEndDate();</span><br><span class="line"> </span><br><span class="line">  </span><br><span class="line">    <span class="comment">///设置请求参数</span></span><br><span class="line">    <span class="type">GetLarkAttendanceUserFlowBatchReqVO</span> <span class="variable">getLarkAttendanceUserFlowBatchReqVO</span> <span class="operator">=</span> GetLarkAttendanceUserFlowBatchReqVO.builder()</span><br><span class="line">            .checkTimeFrom(Long.toString(startDate.getTime() / <span class="number">1000</span>))</span><br><span class="line">            .checkTimeTo(Long.toString(endDate.getTime() / <span class="number">1000</span>))</span><br><span class="line">            .employeeType(ImIntegrationConstants.LARK_EMPLOYEE_ID_TYPE)</span><br><span class="line">            .includeTerminatedUser(<span class="literal">true</span>)</span><br><span class="line">            .userIds(list)</span><br><span class="line">            .build();</span><br><span class="line">    getLarkAttendanceUserFlowBatchReqVO.setAppType(ImIntegrationConstants.LARK_SELF);</span><br><span class="line">    getLarkAttendanceUserFlowBatchReqVO.setCorpId(corpId);</span><br><span class="line">    getLarkAttendanceUserFlowBatchReqVO.setBus(ImIntegrationConstants.REQUEST_BUS);</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//调用飞书接口获取打卡记录</span></span><br><span class="line">    RespEntity&lt;LarkAttendanceUserFlowBatchRespVO&gt; larkAttendanceUserFlowsBatch</span><br><span class="line">            = larkAttendanceApi.getLarkAttendanceUserFlowsBatch(getLarkAttendanceUserFlowBatchReqVO);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == larkAttendanceUserFlowsBatch || <span class="literal">null</span> == larkAttendanceUserFlowsBatch.getData()) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;查询飞书打卡记录接口获取失败 :&#123;&#125;&quot;</span>, JsonUtils.toJsonString(getLarkAttendanceUserFlowBatchReqVO));</span><br><span class="line">        <span class="keyword">return</span> Collections.EMPTY_LIST;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">LarkAttendanceUserFlowBatchRespVO</span> <span class="variable">larkAttendanceUserFlowBatchRespVO</span> <span class="operator">=</span> larkAttendanceUserFlowsBatch.getData();</span><br><span class="line">    List&lt;LarkAttendanceUserFlowRespVO&gt; userFlowList = larkAttendanceUserFlowBatchRespVO.getUserFlowList();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (RespCode.SUCCESS.getCode() != larkAttendanceUserFlowsBatch.getCode()) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;查询飞书打卡记录接口获取失败 exception :&#123;&#125; response:&#123;&#125;&quot;</span>, JsonUtils.toJsonString(getLarkAttendanceUserFlowBatchReqVO)</span><br><span class="line">                , JsonUtils.toJsonString(larkAttendanceUserFlowsBatch));</span><br><span class="line">        <span class="keyword">return</span> Collections.EMPTY_LIST;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> userFlowList == <span class="literal">null</span> ? Collections.EMPTY_LIST : userFlowList;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>通过封装好的<code>LarkAttendanceApi</code>来批量查询用户的飞书打卡记录：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231600447.png" alt="image-20231123160051103"></p>
<p>该接口位于<code>moka-lark</code>下： <strong>LarkAttendanceInnerController.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/inner/moka-lark/attendance&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LarkAttendanceInnerController</span> <span class="keyword">implements</span> <span class="title class_">LarkAttendanceApi</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LarkAttendanceService larkAttendanceService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;批量查询用户飞书打卡记录&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/getLarkAttendanceUserFlowsBatch&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RespEntity&lt;LarkAttendanceUserFlowBatchRespVO&gt; <span class="title function_">getLarkAttendanceUserFlowsBatch</span><span class="params">(<span class="meta">@RequestBody</span> GetLarkAttendanceUserFlowBatchReqVO reqVO)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">LarkAttendanceUserFlowBatchRespVO</span> <span class="variable">respVO</span> <span class="operator">=</span> larkAttendanceService.getLarkAttendanceUserFlowBatch(reqVO);</span><br><span class="line">            <span class="keyword">return</span> RespEntity.respSuccess(respVO);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ServiceException) &#123;</span><br><span class="line">                <span class="keyword">return</span> RespEntity.resp(((ServiceException) e).getCode(), e.getMessage(), <span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> RespEntity.respFail(<span class="string">&quot;LarkAttendanceInnerController getLarkAttendanceUserFlowsBatch error: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>因为是ATS的项目，具体就不细看了，只看最终调用代码,实际上是通过<code>Unirest</code>发送http请求给飞书开放平台来请求打卡数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">getUserFlowBatch</span><span class="params">(String tenantAccessToken, GetLarkAttendanceUserFlowBatchReqVO vo)</span> <span class="keyword">throws</span> UnirestException &#123;</span><br><span class="line">    <span class="comment">// 1.批量查询打卡流水记录url</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> LarkConstants.LARK_OPEN_API_URL + LarkConstants.LARK_V1_ATTENDANCE_USER_FLOWS_QUERY_URL;</span><br><span class="line">    <span class="comment">// 2.构造请求参数</span></span><br><span class="line">    <span class="type">GetLarkUserFlowBatchRequestParam</span> <span class="variable">requestParam</span> <span class="operator">=</span> GetLarkUserFlowBatchRequestParam.builder()</span><br><span class="line">        .employee_type(vo.getEmployeeType())</span><br><span class="line">        .include_terminated_user(vo.getIncludeTerminatedUser())</span><br><span class="line">        .build();</span><br><span class="line">    <span class="type">GetLarkUserFlowBatchRequestBodyParam</span> <span class="variable">requestBodyParam</span> <span class="operator">=</span> GetLarkUserFlowBatchRequestBodyParam.builder()</span><br><span class="line">        .user_ids(vo.getUserIds())</span><br><span class="line">        .check_time_from(vo.getCheckTimeFrom())</span><br><span class="line">        .check_time_to(vo.getCheckTimeTo())</span><br><span class="line">        .build();</span><br><span class="line">    <span class="comment">// 3.请求lark</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        HttpResponse&lt;JsonNode&gt; response = Unirest</span><br><span class="line">            .post(url)</span><br><span class="line">            .header(<span class="string">&quot;Content-Type&quot;</span>, MediaType.APPLICATION_JSON_VALUE)</span><br><span class="line">            .header(<span class="string">&quot;Accept&quot;</span>, MediaType.APPLICATION_JSON_VALUE)</span><br><span class="line">            .header(<span class="string">&quot;Authorization&quot;</span>, tenantAccessToken)</span><br><span class="line">            .queryString(gson.fromJson(gson.toJson(requestParam), Map.class))</span><br><span class="line">            .body(gson.toJson(requestBodyParam))</span><br><span class="line">            .asJson();</span><br><span class="line">        <span class="type">LarkResponse</span> <span class="variable">larkResponse</span> <span class="operator">=</span> JSONObject.parseObject(response.getBody().toString(), LarkResponse.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (response.getStatus() != HttpStatusEnum.SUCCESS.value() || larkResponse.getCode() != OK_CODE) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(larkResponse.getCode(),</span><br><span class="line">                larkResponse.getMsg() + StrUtil.nullToEmpty(larkResponse.getError()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> gson.toJson(larkResponse.getData());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;LarkAttendanceDaoImpl getUserFlowsBatch error! tenantAccessToken=[&#123;&#125;],error=[&#123;&#125;]&quot;</span>,</span><br><span class="line">            tenantAccessToken, e);</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<blockquote>
<p>什么是Unirest？</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231745513.png" alt="image-20231123174534852" style="zoom:33%;" />
</blockquote>
<h4 id="拉取企业微信打卡"><a href="#拉取企业微信打卡" class="headerlink" title="拉取企业微信打卡"></a>拉取企业微信打卡</h4><p>拉取企微打卡数据的逻辑和拉取飞书类似，这里只关注不同点 :grey_exclamation: :grey_exclamation:</p>
<p>先看看入口url：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231633039.png" alt="image-20231123163357591"></p>
<p>拉取企微数据的核心代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">asyncPullPunchData</span><span class="params">(List&lt;Long&gt; list, <span class="type">long</span> entId,<span class="type">long</span> buId, Date startDate, Date endDate,String transId , String corpId, String punchSecret)</span> &#123;</span><br><span class="line">    accessLimitService.wechatAbsenceAcquireByEnt(entId); <span class="comment">//外部接口调用限流</span></span><br><span class="line">    List&lt;HcmWxinUser&gt; hcmWxinUsers = hcmWxinUserDao.findByEmployeeIds(entId, buId, corpId, list);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 从企业微信用户信息列表中过滤出没有原始用户ID（OriginalUserId）的用户列表 noOriUserIdList</span></span><br><span class="line">    List&lt;HcmWxinUser&gt; noOriUserIdList = hcmWxinUsers.stream().filter(hcmWxinUser -&gt; StringUtils.isBlank(hcmWxinUser.getOriginalUserId())).collect(Collectors.toList());</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    对企业微信用户列表 hcmWxinUsers 进行处理，过滤出那些 OriginalUserId 不为空的用户，然后将符合条件的用户映射为一个 Map&lt;Long, String&gt; 类型的集合，其中键为用户的员工ID（getEmployeeId()方法返回的值），值为用户的企业微信用户ID（getOriginalUserId()方法返回的值）</span></span><br><span class="line"><span class="comment">    用作后续调用企业微信接口查询企微用户打卡记录使用</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    Map&lt;Long, String&gt; employeeIdUserIdMap = hcmWxinUsers.stream().filter(hcmWxinUser -&gt; StringUtils.isNotBlank(hcmWxinUser.getOriginalUserId()))</span><br><span class="line">            .collect(Collectors.toMap(HcmWxinUser::getEmployeeId, HcmWxinUser::getOriginalUserId, (v1, v2) -&gt; v2));</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span>(CollectionUtils.isNotEmpty(noOriUserIdList))&#123;</span><br><span class="line">        List&lt;Long&gt; employeeIdList = noOriUserIdList.stream().map(HcmWxinUser::getEmployeeId).collect(Collectors.toList());</span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">      <span class="comment">//通过企业微信接口查询手机号对应的用户ID，仅针对没有原始用户ID（OriginalUserId）的用户</span></span><br><span class="line">        HashMap&lt;Long, String&gt; employeeTelephoneByEmployeeId = imHandleManager.getEmployeeTelephoneByEmployeeId(entId, buId, employeeIdList, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">for</span> (HcmWxinUser hcmWxinUser : noOriUserIdList) &#123;</span><br><span class="line">            <span class="type">Long</span> <span class="variable">employeeId</span> <span class="operator">=</span> hcmWxinUser.getEmployeeId();</span><br><span class="line">            <span class="type">String</span> <span class="variable">telephone</span> <span class="operator">=</span> employeeTelephoneByEmployeeId.get(employeeId);</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isBlank(telephone)) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;该员工查到的手机号不合法，employeeId: &#123;&#125;, telephone: &#123;&#125;&quot;</span>, employeeId, telephone);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">GetUserIdByPhoneReqDTO</span> <span class="variable">params</span> <span class="operator">=</span> GetUserIdByPhoneReqDTO.builder().corpId(hcmWxinUser.getCorpid()).corpSecret(punchSecret).phone(telephone).build();</span><br><span class="line">            <span class="type">String</span> <span class="variable">workWechatUserId</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//如果手机号查询userId查询失败了后续就不查了。</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">redisUserid</span> <span class="operator">=</span> redisClient.getValue(PHONE_USERID_REDIS_PRE+telephone);</span><br><span class="line">                <span class="keyword">if</span>(StringUtils.isNotBlank(redisUserid))&#123;</span><br><span class="line">                    log.info(<span class="string">&quot;redisUserid is :&#123;&#125;&quot;</span>,redisUserid);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">              </span><br><span class="line">              <span class="comment">//通过手机号获取企业微信id</span></span><br><span class="line">                AtsRespEntity&lt;GetUserIdByPhoneRespDTO&gt;  workWechatUserIdByPhone = iWorkWechatAddressBookUserInnerApi.getWorkwechatUserIdByPhone(params);</span><br><span class="line">                log.info(<span class="string">&quot;通过手机号换取userId结果：&#123;&#125;&quot;</span>, JacksonUtils.toJson(workWechatUserIdByPhone));</span><br><span class="line">                <span class="keyword">if</span>(workWechatUserIdByPhone.isSuccess())&#123;</span><br><span class="line">              <span class="comment">/*</span></span><br><span class="line"><span class="comment">              *如果接口调用成功（workWechatUserIdByPhone.isSuccess()），</span></span><br><span class="line"><span class="comment">               从响应结果中获取用户ID，并将其设置为用户的原始用户ID（OriginalUserId）。</span></span><br><span class="line"><span class="comment">               更新 employeeIdUserIdMap 中的映射关系，表示该用户已经有了原始用户ID。</span></span><br><span class="line"><span class="comment">               调用 hcmWxinUserDaoAdapter.buildUserId(hcmWxinUser) 更新数据库中的用户信息</span></span><br><span class="line"><span class="comment">              */</span></span><br><span class="line">                    <span class="type">GetUserIdByPhoneRespDTO</span> <span class="variable">data</span> <span class="operator">=</span> workWechatUserIdByPhone.getData();</span><br><span class="line">                    workWechatUserId = data.getWorkwechatUserId();</span><br><span class="line">                    hcmWxinUser.setOriginalUserId(workWechatUserId);</span><br><span class="line">                    employeeIdUserIdMap.put(employeeId, workWechatUserId);</span><br><span class="line">                    hcmWxinUserDaoAdapter.buildUserId(hcmWxinUser);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="comment">//设置锁的过期时间为12小时，即在接下来的12小时内，对于相同的手机号不再进行用户ID的查询</span></span><br><span class="line">                    <span class="keyword">try</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        redisClient.setValue(PHONE_USERID_REDIS_PRE + telephone, telephone, <span class="number">12</span>, TimeUnit.HOURS);</span><br><span class="line">                        log.info(<span class="string">&quot;query  by phone:&#123;&#125;&quot;</span>, telephone);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e)</span><br><span class="line">                    &#123;</span><br><span class="line">                        log.error(<span class="string">&quot;redis function error. userid:&#123;&#125; , phone:&#123;&#125;&quot;</span>, workWechatUserId, telephone,e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;使用punchSecret获取员工userId失败:入参&#123;&#125;:租户:&#123;&#125;&quot;</span>,JacksonUtils.toJson(params),entId,e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;重建原始userId结果:&#123;&#125;&quot;</span>,JacksonUtils.toJson(noOriUserIdList));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;ChannelCheckInDataRes&gt; resList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;String&gt; userIdList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(employeeIdUserIdMap.values());</span><br><span class="line">    List&lt;GetWorkwechatCardRespDTO&gt; punchRecord = getPunchRecord(userIdList, startDate, endDate, corpId, punchSecret);</span><br><span class="line">    Map&lt;String, List&lt;GetWorkwechatCardRespDTO&gt;&gt; punchRecordMap = punchRecord.stream().collect(Collectors.groupingBy(GetWorkwechatCardRespDTO::getUserId));</span><br><span class="line">    <span class="keyword">if</span>(!punchRecordMap.isEmpty())&#123;</span><br><span class="line">        log.info(<span class="string">&quot;查询到的企业微信打卡数据:&#123;&#125;&quot;</span>, JacksonUtils.toJson(punchRecordMap));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (Long employeeId : list) &#123;</span><br><span class="line">        <span class="type">ChannelCheckInDataRes</span> <span class="variable">channelCheckInDataRes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChannelCheckInDataRes</span>();</span><br><span class="line">        channelCheckInDataRes.setChannel(ImCheckInChannelEnum.WEIXIN);</span><br><span class="line">        channelCheckInDataRes.setBuId(buId);</span><br><span class="line">        channelCheckInDataRes.setEntId(entId);</span><br><span class="line">        channelCheckInDataRes.setEmployeeId(employeeId);</span><br><span class="line">        channelCheckInDataRes.setTransId(transId);</span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> employeeIdUserIdMap.get(employeeId);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(userId) &amp;&amp; punchRecordMap.containsKey(userId)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (GetWorkwechatCardRespDTO datum : punchRecordMap.get(userId)) &#123;</span><br><span class="line">                <span class="type">ChannelCheckInDataRes</span> <span class="variable">channelCheckInDataResSuccess</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChannelCheckInDataRes</span>();</span><br><span class="line">                BeanUtils.copyProperties(channelCheckInDataRes, channelCheckInDataResSuccess);</span><br><span class="line">                channelCheckInDataResSuccess.setWechatException(datum.getExceptionType());</span><br><span class="line">                channelCheckInDataResSuccess.setCheckInSource(datum.getCheckinSource());</span><br><span class="line">                channelCheckInDataResSuccess.setCheckInTime(datum.getCheckinTime());</span><br><span class="line">                channelCheckInDataResSuccess.setDeviceId(datum.getDeviceId());</span><br><span class="line">                channelCheckInDataResSuccess.setLocationDetail(datum.getLocationDetail());</span><br><span class="line">                channelCheckInDataResSuccess.setOutsideClock(datum.getCheckinType());</span><br><span class="line">                channelCheckInDataResSuccess.setOutsideRemark(datum.getNotes());</span><br><span class="line">                channelCheckInDataResSuccess.setOriginData(JacksonUtils.toJson(datum));</span><br><span class="line">                resList.add(channelCheckInDataResSuccess);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        resList.add(channelCheckInDataRes);</span><br><span class="line">    &#125;</span><br><span class="line">    absenceMsgProducer.pushMsg(resList,entId);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ol>
<li><p><strong>限流控制：</strong></p>
<ul>
<li>调用 <code>accessLimitService.wechatAbsenceAcquireByEnt(entId)</code> 方法，进行企业微信外部接口调用的限流控制。</li>
</ul>
</li>
<li><p><strong>获取企业微信用户信息：</strong></p>
<ul>
<li>通过企业ID（<code>entId</code>）、部门ID（<code>buId</code>）、企业微信CorpId（<code>corpId</code>）、员工ID列表（<code>list</code>）等参数，从数据库中获取企业微信用户信息列表 <code>hcmWxinUsers</code>。</li>
</ul>
</li>
<li><p><strong>获取无原始用户ID的用户列表 <code>noOriUserIdList</code>：</strong></p>
<ul>
<li>从企业微信用户信息列表中过滤出没有原始用户ID（<code>OriginalUserId</code>）的用户列表 <code>noOriUserIdList</code></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231644944.png" alt="image-20231123164406437"></p>
</li>
<li><p><strong>获取员工ID与企业微信用户ID的映射关系 <code>employeeIdUserIdMap</code>：</strong></p>
<ul>
<li>通过 Java 8 的 Stream API，将具有原始用户ID的用户信息映射为员工ID与企业微信用户ID的关系，存储在 <code>employeeIdUserIdMap</code> 中。</li>
</ul>
</li>
<li><p><strong>处理无原始用户ID的用户列表：</strong></p>
<ul>
<li>对于没有原始用户ID的用户，尝试通过手机号码从企业微信获取用户ID。</li>
<li>如果手机号在Redis中有记录，则跳过；否则，通过企业微信接口查询手机号对应的用户ID，并更新用户信息。</li>
</ul>
</li>
<li><p><strong>构建推送打卡数据的结果列表 <code>resList</code>：</strong></p>
<ul>
<li>通过用户ID列表调用 <code>getPunchRecord</code> 方法，获取企业微信用户的打卡记录。</li>
<li>根据打卡记录构建推送打卡数据的结果列表 <code>resList</code>。</li>
</ul>
</li>
<li><p><strong>推送打卡数据：</strong></p>
<ul>
<li>调用 <code>absenceMsgProducer.pushMsg(resList, entId)</code> 方法，将打卡数据异步推送到消息队列。</li>
</ul>
</li>
</ol>
<p><strong>1、调用外部api限流频率差异</strong></p>
<p>令牌生成的速率为 10 令牌每秒（即每秒最多允许 10 次请求），缓冲区大小为 <code>LIMIT_BUFFER</code>。<code>LIMIT_BUFFER</code> 的值应该是一个小于令牌生成速率的数值，用于确保即使在速率正好用尽时，请求也能够通过。在这里，速率是每秒 10 次，<code>LIMIT_BUFFER</code> 为 1，所以实际上是每秒最多允许 11 次请求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">wechatAbsenceAcquireByEnt</span><span class="params">(Long entId)</span> &#123;</span><br><span class="line">       <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;mobile:limiter:wXin:absence:&quot;</span> + entId;</span><br><span class="line">       log.info(<span class="string">&quot;wechatAbsenceAcquireByEnt:&#123;&#125;&quot;</span>, key);</span><br><span class="line">       redisLimitTemplate.initRateLimiter(key, <span class="number">10</span> - LIMIT_BUFFER, <span class="number">1</span>, RateIntervalUnit.SECONDS);</span><br><span class="line">       <span class="type">boolean</span> <span class="variable">acquire</span> <span class="operator">=</span> redisLimitTemplate.tryAcquire(key, LIMITER_WAIT_TIME, TimeUnit.SECONDS);</span><br><span class="line">       <span class="keyword">if</span> (!acquire) &#123;</span><br><span class="line">           log.info(<span class="string">&quot;请求被限流控制，entId:&#123;&#125;&quot;</span>,entId);</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CustomException</span>(<span class="string">&quot;请求被限流控制，请稍后重试&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<p>企业微信开发者中心规定了接口的访问频率：<a target="_blank" rel="noopener" href="https://developer.work.weixin.qq.com/document/path/90312">访问频率限制</a></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311241102113.png" alt="image-20231124110230586" style="zoom: 33%;" />







<p><strong>2、类似飞书、同样有一张表记录企业微信用户和 hcm 租户之间的对应关系：</strong><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231632367.png" alt="image-20231123163251930" style="zoom:33%;" /></p>
<p>同时，表&#96;&#96;hcm_wxin_user&#96;记录了所有企业微信用户隶属于的hcm租户信息：</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231637967.png" alt="image-20231123163706509" style="zoom:33%;" />





<p>3、<strong>针对hcm-wxin-user表中的空用户问题处理（处理缓存击穿）</strong></p>
<blockquote>
<p>先来理解一下什么是 <code>original_user_id</code> ？</p>
<p>1、数据库中有一张表 hcm_wxin_user，该表记录了所有hcm用户在moka中的id，同时记录了这些用户在企业微信中的原始id</p>
<p>2、在对企业微信用户列表 <code>hcmWxinUsers</code> 进行处理时，过滤出那些 <code>OriginalUserId</code> 不为空的用户，然后将符合条件的用户映射为一个 <code>Map&lt;Long, String&gt;</code> 类型的集合，其中键为用户的员工ID（<code>getEmployeeId()</code>方法返回的值），值为用户的企业微信用户ID（<code>getOriginalUserId()</code>方法返回的值）</p>
<p>3、最终调用企微api批量查询这些员工的打卡记录，传入参数则为<code>OriginalUserId</code>的<code>List</code></p>
</blockquote>
<p>在处理那些noOriginUserId的用户时：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">List&lt;HcmWxinUser&gt; noOriUserIdList = hcmWxinUsers.stream().filter(hcmWxinUser -&gt; StringUtils.isBlank(hcmWxinUser.getOriginalUserId())).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(CollectionUtils.isNotEmpty(noOriUserIdList))&#123;</span><br><span class="line">  List&lt;Long&gt; employeeIdList = noOriUserIdList.stream().map(HcmWxinUser::getEmployeeId).collect(Collectors.toList());</span><br><span class="line">  HashMap&lt;Long, String&gt; employeeTelephoneByEmployeeId = imHandleManager.getEmployeeTelephoneByEmployeeId(entId, buId, employeeIdList, <span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">for</span> (HcmWxinUser hcmWxinUser : noOriUserIdList) &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">employeeId</span> <span class="operator">=</span> hcmWxinUser.getEmployeeId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">telephone</span> <span class="operator">=</span> employeeTelephoneByEmployeeId.get(employeeId);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(telephone)) &#123;</span><br><span class="line">      log.warn(<span class="string">&quot;该员工查到的手机号不合法，employeeId: &#123;&#125;, telephone: &#123;&#125;&quot;</span>, employeeId, telephone);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">GetUserIdByPhoneReqDTO</span> <span class="variable">params</span> <span class="operator">=</span> GetUserIdByPhoneReqDTO.builder().corpId(hcmWxinUser.getCorpid()).corpSecret(punchSecret).phone(telephone).build();</span><br><span class="line">    <span class="type">String</span> <span class="variable">workWechatUserId</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//如果在redis中查询到对应的原始id，直接跳过该员工</span></span><br><span class="line">      <span class="type">String</span> <span class="variable">redisUserid</span> <span class="operator">=</span> redisClient.getValue(PHONE_USERID_REDIS_PRE+telephone);</span><br><span class="line">      <span class="keyword">if</span>(StringUtils.isNotBlank(redisUserid))&#123;</span><br><span class="line">        log.info(<span class="string">&quot;redisUserid is :&#123;&#125;&quot;</span>,redisUserid);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">      <span class="comment">//如果redis中没有存储该员工对应的原始id，则通过企业微信通讯录用户inner接口，通过该员工手机号来获取该员工的企业微信id</span></span><br><span class="line">      AtsRespEntity&lt;GetUserIdByPhoneRespDTO&gt;  workWechatUserIdByPhone = iWorkWechatAddressBookUserInnerApi.getWorkwechatUserIdByPhone(params);</span><br><span class="line">      log.info(<span class="string">&quot;通过手机号换取userId结果：&#123;&#125;&quot;</span>, JacksonUtils.toJson(workWechatUserIdByPhone));</span><br><span class="line">      <span class="keyword">if</span>(workWechatUserIdByPhone.isSuccess())&#123;</span><br><span class="line">        <span class="type">GetUserIdByPhoneRespDTO</span> <span class="variable">data</span> <span class="operator">=</span> workWechatUserIdByPhone.getData();</span><br><span class="line">        workWechatUserId = data.getWorkwechatUserId();</span><br><span class="line">        hcmWxinUser.setOriginalUserId(workWechatUserId);</span><br><span class="line">        employeeIdUserIdMap.put(employeeId, workWechatUserId);</span><br><span class="line">        hcmWxinUserDaoAdapter.buildUserId(hcmWxinUser);</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//调用接口查询到手机号后，redis加一个锁12小时内不再查询。</span></span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">          redisClient.setValue(PHONE_USERID_REDIS_PRE + telephone, telephone, <span class="number">12</span>, TimeUnit.HOURS);</span><br><span class="line">          log.info(<span class="string">&quot;query  by phone:&#123;&#125;&quot;</span>, telephone);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">          log.error(<span class="string">&quot;redis function error. userid:&#123;&#125; , phone:&#123;&#125;&quot;</span>, workWechatUserId, telephone,e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      log.error(<span class="string">&quot;使用punchSecret获取员工userId失败:入参&#123;&#125;:租户:&#123;&#125;&quot;</span>,JacksonUtils.toJson(params),entId,e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  log.info(<span class="string">&quot;重建原始userId结果:&#123;&#125;&quot;</span>,JacksonUtils.toJson(noOriUserIdList));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>在通过该员工手机号来获取它在企业微信中的对应id时，需要调用以下接口：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231702367.png" alt="image-20231123170209869"></p>
<p>如果通过该员工的手机号成功获取到其在企微中的<code>userId</code></p>
<ul>
<li>将其设置为用户的原始用户ID（<code>OriginalUserId</code>）。</li>
<li>更新 <code>employeeIdUserIdMap</code> 中的映射关系，表示该用户已经有了原始用户ID。</li>
<li>调用 <code>hcmWxinUserDaoAdapter.buildUserId(hcmWxinUser)</code> 更新数据库中的用户信息</li>
</ul>
<p>如果通过手机号查询用户ID失败，设置锁的过期时间为12小时，即在接下来的12小时内，对于相同的手机号不再进行用户ID的查询</p>
<p>即在发生失败时，通过 <code>redisClient</code> 设置一个锁（实际上是在 Redis 中设置一个键值对），以避免在接下来的12小时内对相同手机号进行用户ID的重复查询。这个锁的键是由手机号构建的，而值则被设置为手机号本身：<code>redisClient.setValue(PHONE_USERID_REDIS_PRE + telephone, telephone, 12, TimeUnit.HOURS);</code></p>
<p>4、外部调用企业微信接口批量查询打卡记录</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;GetWorkwechatCardRespDTO&gt; <span class="title function_">getPunchRecord</span><span class="params">(List&lt;String&gt; list, Date startDate, Date endDate, String corpId, String punchSecret)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果请求的用户id为空，直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isEmpty(list))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">GetWorkwechatCardReqDTO</span> <span class="variable">params</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetWorkwechatCardReqDTO</span>();</span><br><span class="line">    params.setCorpId(corpId);</span><br><span class="line">    params.setStarttime(startDate.getTime() / <span class="number">1000</span>);</span><br><span class="line">    params.setEndtime(endDate.getTime() / <span class="number">1000</span>);</span><br><span class="line">    params.setUseridlist(list);</span><br><span class="line">    params.setOpencheckindatatype(<span class="number">3</span>);<span class="comment">//固定入参</span></span><br><span class="line">    params.setCorpSecret(punchSecret);</span><br><span class="line">    params.setSuiteType(suite);</span><br><span class="line">    log.info(<span class="string">&quot;查询企业微信打卡记录入参:&#123;&#125;&quot;</span>, JacksonUtils.toJson(params));</span><br><span class="line">    AtsRespEntity&lt;List&lt;GetWorkwechatCardRespDTO&gt;&gt; resp = <span class="keyword">new</span> <span class="title class_">AtsRespEntity</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        resp = workWechatUserInnerApi.getCard(params); <span class="comment">//外部调用 </span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;企业微信获取打卡数据异常 exception :&#123;&#125;&quot;</span>,exception);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//log.info(&quot;查询企业微信打卡记录出参:&#123;&#125;&quot;, JsonUtils.toJsonString(resp));</span></span><br><span class="line">    <span class="keyword">if</span> (resp.isSuccess()) &#123;</span><br><span class="line">        <span class="keyword">return</span> resp.getData();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231732254.png" alt="image-20231123173216728" style="zoom:50%;" />



<p>该接口位置在moka-workwechat下，只看核心代码,实际上还是发送http请求来获取数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> List&lt;GetWorkwechatCardRespDTO&gt; <span class="title function_">getCard</span><span class="params">(GetWorkwechatCardReqDTO dto)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//获取token</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">accessToken</span> <span class="operator">=</span> getCardToken(dto.getCorpId(), dto.getCorpSecret());</span><br><span class="line">       <span class="keyword">if</span> (StringUtils.isBlank(accessToken)) &#123;</span><br><span class="line">           log.info(<span class="string">&quot;get accessToken error. corpId:&#123;&#125;,corpSecret:&#123;&#125;&quot;</span>, dto.getCorpId(), dto.getCorpSecret());</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;get accessToken error&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 兼容之前老代码，之前useridlist是空数组时，企业微信接口报错，该接口返回值为空数组</span></span><br><span class="line">       <span class="comment">// 所以现在useridlist是空数组时，不调用企业微信接口，直接返回空数组</span></span><br><span class="line">       <span class="keyword">if</span> (ObjectUtil.isEmpty(dto.getUseridlist()) || <span class="number">0</span> == dto.getUseridlist().size()) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//组装参数获取打卡记录</span></span><br><span class="line">       Map&lt;String, Object&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">       params.put(<span class="string">&quot;opencheckindatatype&quot;</span>, CHECKIN_DATA_TYPE);</span><br><span class="line">       params.put(<span class="string">&quot;useridlist&quot;</span>, dto.getUseridlist());</span><br><span class="line">       params.put(<span class="string">&quot;starttime&quot;</span>, dto.getStarttime());</span><br><span class="line">       params.put(<span class="string">&quot;endtime&quot;</span>, dto.getEndtime());</span><br><span class="line">       <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> HttpClientUtil.postJson(CHECKIN_DATA_URL + accessToken, JSONUtil.toJsonStr(params), <span class="literal">null</span>);</span><br><span class="line">       log.info(<span class="string">&quot;get checkin data result:&#123;&#125;&quot;</span>, result);</span><br><span class="line">       <span class="type">JSON</span> <span class="variable">json</span> <span class="operator">=</span> JSONUtil.parse(result);</span><br><span class="line">       <span class="type">Integer</span> <span class="variable">errCode</span> <span class="operator">=</span> (Integer) JSONUtil.getByPath(json, <span class="string">&quot;errcode&quot;</span>);</span><br><span class="line">       <span class="keyword">if</span> (errCode != <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(JSONUtil.getByPath(json, <span class="string">&quot;errmsg&quot;</span>) + <span class="string">&quot;&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//解析结果</span></span><br><span class="line">       <span class="type">JSONArray</span> <span class="variable">dataList</span> <span class="operator">=</span> (JSONArray) JSONUtil.getByPath(json, <span class="string">&quot;checkindata&quot;</span>);</span><br><span class="line">       Iterator&lt;Object&gt; iterator = dataList.stream().iterator();</span><br><span class="line">       List&lt;GetWorkwechatCardRespDTO&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(dataList.size());</span><br><span class="line">       <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">           <span class="type">JSONObject</span> <span class="variable">object</span> <span class="operator">=</span> (JSONObject) iterator.next();</span><br><span class="line">           <span class="type">GetWorkwechatCardRespDTO</span> <span class="variable">respDTO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetWorkwechatCardRespDTO</span>();</span><br><span class="line">           respDTO.setUserId(object.getStr(<span class="string">&quot;userid&quot;</span>));</span><br><span class="line">           respDTO.setCheckinTime(object.getLong(<span class="string">&quot;checkin_time&quot;</span>));</span><br><span class="line">           respDTO.setDeviceId(object.getStr(<span class="string">&quot;deviceid&quot;</span>));</span><br><span class="line">           respDTO.setLocationDetail(object.getStr(<span class="string">&quot;location_detail&quot;</span>));</span><br><span class="line">           respDTO.setCheckinSource(<span class="string">&quot;企业微信&quot;</span>);</span><br><span class="line">           respDTO.setNotes(object.getStr(<span class="string">&quot;notes&quot;</span>));</span><br><span class="line">           <span class="comment">//外出打卡定义为外勤打卡</span></span><br><span class="line">           <span class="keyword">if</span> (<span class="string">&quot;外出打卡&quot;</span>.equals(object.getStr(<span class="string">&quot;checkin_type&quot;</span>))) &#123;</span><br><span class="line">               respDTO.setCheckinType(<span class="literal">true</span>);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               respDTO.setCheckinType(<span class="literal">false</span>);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">//有wifi名称时，定义为Wi-Fi打卡，没有时判断经纬度</span></span><br><span class="line">           <span class="type">String</span> <span class="variable">wifiName</span> <span class="operator">=</span> object.getStr(<span class="string">&quot;wifiname&quot;</span>);</span><br><span class="line">           <span class="keyword">if</span> (StringUtils.isNotBlank(wifiName)) &#123;</span><br><span class="line">               respDTO.setCheckinMethod(<span class="number">1</span>);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="type">Long</span> <span class="variable">lat</span> <span class="operator">=</span> object.getLong(<span class="string">&quot;lat&quot;</span>);</span><br><span class="line">               <span class="type">Long</span> <span class="variable">lng</span> <span class="operator">=</span> object.getLong(<span class="string">&quot;lng&quot;</span>);</span><br><span class="line">               <span class="keyword">if</span> (Objects.nonNull(lat) &amp;&amp; Objects.nonNull(lng)) &#123;</span><br><span class="line">                   respDTO.setCheckinMethod(<span class="number">0</span>);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           respDTO.setExceptionType(object.getStr(<span class="string">&quot;exception_type&quot;</span>));</span><br><span class="line">           respDTO.setWifiMac(object.getStr(<span class="string">&quot;wifimac&quot;</span>));</span><br><span class="line">           respDTO.setMediaIds(object.get(<span class="string">&quot;mediaids&quot;</span>, List.class));</span><br><span class="line">           respDTO.setGroupName(object.getStr(<span class="string">&quot;groupname&quot;</span>));</span><br><span class="line">           respDTO.setGroupId(object.getInt(<span class="string">&quot;groupid&quot;</span>));</span><br><span class="line">           respDTO.setScheduleId(object.getInt(<span class="string">&quot;schedule_id&quot;</span>));</span><br><span class="line">           respDTO.setTimelineId(object.getInt(<span class="string">&quot;timeline_id&quot;</span>));</span><br><span class="line">           list.add(respDTO);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> list;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * post json类型 contentType为json</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">postJson</span><span class="params">(String url, String json, Map&lt;String, String&gt; headers)</span> &#123;</span><br><span class="line"></span><br><span class="line">       <span class="type">CloseableHttpClient</span> <span class="variable">httpClient</span> <span class="operator">=</span> HttpClientBuilder.create().build();</span><br><span class="line">       <span class="type">HttpPost</span> <span class="variable">post</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpPost</span>(url);</span><br><span class="line">       post.setHeader(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">       <span class="keyword">if</span> (Objects.nonNull(headers)) &#123;</span><br><span class="line">           <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : headers.entrySet()) &#123;</span><br><span class="line">               <span class="type">String</span> <span class="variable">mapKey</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">               <span class="type">String</span> <span class="variable">mapValue</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line">               post.setHeader(mapKey, mapValue);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="type">StringEntity</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringEntity</span>(json, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">           post.setEntity(s);</span><br><span class="line">           log.info(<span class="string">&quot;HttpUtilsConsumer.doPostJson请求入参post=&quot;</span> + JSON.toJSONString(post));</span><br><span class="line">           <span class="type">HttpResponse</span> <span class="variable">res</span> <span class="operator">=</span> httpClient.execute(post);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (HttpStatus.SC_OK &lt;= res.getStatusLine().getStatusCode() &amp;&amp; res.getStatusLine().getStatusCode() &lt; HttpStatus.SC_MULTIPLE_CHOICES) &#123;</span><br><span class="line">               <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> EntityUtils.toString(res.getEntity());<span class="comment">// 返回json格式：</span></span><br><span class="line">               response = result;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               log.info(<span class="string">&quot;postJson httpstatus error &#123;&#125; &#123;&#125;&quot;</span>, res.getStatusLine().getStatusCode(), EntityUtils.toString(res.getEntity()));</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           log.error(<span class="string">&quot;http接口调用失败&quot;</span> + <span class="string">&quot;,url=&quot;</span> + url + <span class="string">&quot;,param=&quot;</span> + json, e);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> response;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>









<h4 id="拉取钉钉打卡"><a href="#拉取钉钉打卡" class="headerlink" title="拉取钉钉打卡"></a>拉取钉钉打卡</h4><p>钉钉同理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 打卡接口钉钉单独定义接口权限每S 40次</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> entId</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dingAbsenceAcquireByEnt</span><span class="params">(Long entId)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;mobile:limiter:ding:absence:&quot;</span> + entId;</span><br><span class="line">    log.info(<span class="string">&quot;dingAbsenceAcquireByEnt:&#123;&#125; &quot;</span>, key);</span><br><span class="line">    redisLimitTemplate.initRateLimiter(key, <span class="number">40</span> - LIMIT_BUFFER, <span class="number">1</span>, RateIntervalUnit.SECONDS);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">acquire</span> <span class="operator">=</span> redisLimitTemplate.tryAcquire(key, LIMITER_WAIT_TIME, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">if</span> (!acquire) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;请求被限流控制，entId:&#123;&#125;&quot;</span>,entId);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CustomException</span>(<span class="string">&quot;请求被限流控制，请稍后重试&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h3 id="1-3-消费者批量消费"><a href="#1-3-消费者批量消费" class="headerlink" title="1.3 消费者批量消费"></a><a name="consumer-batch"></a>1.3 消费者批量消费</h3><p>针对上述提到的最后一步消息推送，<code>hcm-mobile</code>服务会通过<code>kafka</code>发送一条消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> HcmAbsenceMsgProducer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> yangpeixu@mokahr.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2022/1/29 2:46 下午</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Desc</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HcmAbsenceMsgProducer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;topic.hcm_abs_batch_sync_channel_record&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String topic;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> InstanceProfileConfig instanceProfileConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DefaultNoLogMsgProducer defaultNoLogMsgProducer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 推送打卡数据</span></span><br><span class="line"><span class="comment">     * 1.基于员工进行分组推送</span></span><br><span class="line"><span class="comment">     * 2.每个消息最多600条 ； 循环推送</span></span><br><span class="line"><span class="comment">     * 3.key 使用员工ID</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> resList</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> entId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pushMsg</span><span class="params">(List&lt;ChannelCheckInDataRes&gt; resList, Long entId)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(resList)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 每个消息的最大条数</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">countAbs</span> <span class="operator">=</span> MokaConfig.getInstance().getStrPropertyFromDefault(ApolloConstants.HCM_MOBILE_MOKA_ABSENCE_MSG_COUNT);</span><br><span class="line">        <span class="type">int</span> <span class="variable">partitionRecord</span> <span class="operator">=</span> resList.size();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(countAbs)) &#123;</span><br><span class="line">            partitionRecord = Integer.parseInt(countAbs);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将打卡数据列表按员工号进行分组</span></span><br><span class="line">        Map&lt;Long, List&lt;ChannelCheckInDataRes&gt;&gt; employeeDataMap = resList.stream().collect(Collectors.groupingBy(ChannelCheckInDataRes::getEmployeeId));</span><br><span class="line">        <span class="keyword">for</span> (Long employeeId : employeeDataMap.keySet()) &#123;</span><br><span class="line">            List&lt;ChannelCheckInDataRes&gt; employeeCheckInDataList = employeeDataMap.get(employeeId);</span><br><span class="line">          </span><br><span class="line">       <span class="comment">//遍历每个员工的打卡数据，将数据按配置的每个消息的最大条数进行分割，生成多个消息   </span></span><br><span class="line">            List&lt;List&lt;ChannelCheckInDataRes&gt;&gt; checkInLists = ListUtils.partition(employeeCheckInDataList, partitionRecord);</span><br><span class="line">          </span><br><span class="line">      </span><br><span class="line">            <span class="keyword">for</span> (List&lt;ChannelCheckInDataRes&gt; singleEmployeeDataList : checkInLists) &#123;</span><br><span class="line">                <span class="type">AbsClockCheckInDataDto</span> <span class="variable">absClockCheckInDataDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AbsClockCheckInDataDto</span>();</span><br><span class="line">                absClockCheckInDataDto.setEntId(entId);</span><br><span class="line">                absClockCheckInDataDto.setBuId(singleEmployeeDataList.get(<span class="number">0</span>).getBuId());</span><br><span class="line">                absClockCheckInDataDto.setEmployeeId(employeeId);</span><br><span class="line">                absClockCheckInDataDto.setCheckInDataResDtoList(singleEmployeeDataList);</span><br><span class="line"></span><br><span class="line">                <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> Message.builder().sendTime(<span class="keyword">new</span> <span class="title class_">Date</span>())</span><br><span class="line">                        .msgId(employeeId)</span><br><span class="line">                        .isSequential(<span class="literal">false</span>)</span><br><span class="line">                        .topic(getTopic(entId))</span><br><span class="line">                        .body(JacksonUtils.toJson(absClockCheckInDataDto))</span><br><span class="line">                        .build();</span><br><span class="line">                log.info(<span class="string">&quot;HcmAbsenceMsgProducer pushMsg -&#123;&#125;&quot;</span>, JacksonUtils.toJson(message));</span><br><span class="line">                defaultNoLogMsgProducer.pushMsg(message); <span class="comment">//发送消息</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 根据企业ID、环境和灰度发布状态决定是否使用灰度发布的消息主题。如果需要切换到灰度主题，将消息主题的前缀修改为 &quot;gray_&quot;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTopic</span><span class="params">(Long entId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">newTopic</span> <span class="operator">=</span> topic;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">shouldChange2GrayTopic</span> <span class="operator">=</span> GrayUtils.shouldChange2GrayTopic(entId, instanceProfileConfig.getEnv(), instanceProfileConfig.getGrayReleased());</span><br><span class="line">        <span class="keyword">if</span> (shouldChange2GrayTopic) &#123;</span><br><span class="line">            newTopic = <span class="string">&quot;gray_&quot;</span> + topic;</span><br><span class="line">            log.info(<span class="string">&quot;getTopic should be replace to new topic:&#123;&#125;, originTopic:&#123;&#125;&quot;</span>, newTopic, topic);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> newTopic;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>其中 topic 字段将被赋予默认值 <code>hcm_$&#123;spring.kafka.active&#125;_abs_batch_sync_channel_record</code>，<code>$&#123;spring.kafka.active&#125;</code> 是一个占位符，它会在运行时被实际的配置值替换，例如 local、prod、staging</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;topic.hcm_abs_batch_sync_channel_record&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String topic;</span><br></pre></td></tr></table></figure>



<p>至于该<code>kafka</code>消息的消费者，则看具体业务，</p>
<p>比如该打卡业务(hcm-absence-clock)中的同步飞书打卡数据，最终需要把指定租户下员工的飞书打卡记录写入到 **<code>hcm_abs_lark_origin_clock_record</code>**表中：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231823326.png" alt="image-20231123182328699"></p>
<p>注意这里的<code>containerFactory</code>  创建了一个 Kafka 监听器容器工厂 ，这个工厂配置了 Kafka 消费者，使其能够支持<strong>批量消费</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> KafkaListenerContainerFactory&lt;ConcurrentMessageListenerContainer&lt;String, String&gt;&gt; <span class="title function_">batchConsumeListenContainerFactory</span><span class="params">()</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;---KafkaListenerContainerFactory---&quot;</span>);</span><br><span class="line">    ConcurrentKafkaListenerContainerFactory&lt;String, String&gt; factory = <span class="keyword">new</span> <span class="title class_">ConcurrentKafkaListenerContainerFactory</span>&lt;&gt;();</span><br><span class="line">    log.info(<span class="string">&quot;---ConcurrentKafkaListenerContainerFactory---new&quot;</span>);</span><br><span class="line">    factory.getContainerProperties().setAckMode(AbstractMessageListenerContainer.AckMode.MANUAL);</span><br><span class="line">    factory.setConsumerFactory(<span class="built_in">this</span>.consumerFactory());</span><br><span class="line">    log.info(<span class="string">&quot;---ConcurrentKafkaListenerContainerFactory---setConsumerFactory&quot;</span>);</span><br><span class="line">    factory.setConcurrency(<span class="built_in">this</span>.concurrency);</span><br><span class="line">    factory.getContainerProperties().setPollTimeout(<span class="number">2500L</span>);</span><br><span class="line">    factory.getContainerProperties().setIdleEventInterval(<span class="number">6000L</span>);</span><br><span class="line">    <span class="comment">// 开启批量消费</span></span><br><span class="line">    factory.setBatchListener(<span class="literal">true</span>);</span><br><span class="line">    log.info(<span class="string">&quot;---ConcurrentKafkaListenerContainerFactory---return--&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> factory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在从 Kafka 消息中提取批量同步的打卡记录数据，按照员工的唯一键进行分组，构建一个映射关系，其中键是员工的唯一键，值是该员工对应的打卡记录列表后，就执行真正的<code>batchSync</code>批量同步逻辑 <a href="#syncOptimize">同步打卡数据按employeeId分组</a>：&#x3D;&#x3D;batchSyncChannelRecordService.handleChannelRecords(employeeUniqkeyChannelRecordsMap);&#x3D;&#x3D;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleChannelRecords</span><span class="params">(Map&lt;String, List&lt;ChannelCheckInDataResDto&gt;&gt; employeeUniqkeyChannelRecordsMap)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (MapUtils.isEmpty(employeeUniqkeyChannelRecordsMap)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">MokaStopWatch</span> <span class="variable">stopWatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MokaStopWatch</span>(<span class="string">&quot;批量同步打卡数据&quot;</span>);</span><br><span class="line"></span><br><span class="line">    stopWatch.start(<span class="string">&quot;处理当前同步的数据以及状态&quot;</span>);</span><br><span class="line">    <span class="comment">// 处理当前同步的数据以及状态</span></span><br><span class="line">    handleChannelSyncTaskData(employeeUniqkeyChannelRecordsMap);</span><br><span class="line">    stopWatch.stop();</span><br><span class="line"></span><br><span class="line">    stopWatch.start(<span class="string">&quot;处理原始同步的打卡数据&quot;</span>);</span><br><span class="line">    <span class="comment">// 处理同步的打卡数据</span></span><br><span class="line">    Map&lt;String, List&lt;ClockInRecord&gt;&gt; employeeUniqKeyRecordsMap = Maps.newHashMap();</span><br><span class="line">    <span class="keyword">for</span> (String employeeUniqKey : employeeUniqkeyChannelRecordsMap.keySet()) &#123;</span><br><span class="line">        List&lt;ChannelCheckInDataResDto&gt; channelRecords = employeeUniqkeyChannelRecordsMap.get(employeeUniqKey);</span><br><span class="line">        <span class="type">Long</span> <span class="variable">employeeId</span> <span class="operator">=</span> ClockRecordUtil.parseEmployeeIdFromEmployeeUniqKey(employeeUniqKey);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(channelRecords)) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;&#123;&#125;没有需要同步的数据&quot;</span>, employeeId);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> SYNC_CHANNEL_DATA_KEY_PREFIX + employeeId;</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(key);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">lockFlag</span> <span class="operator">=</span> lock.tryLock(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">            <span class="keyword">if</span> (!lockFlag) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;当前员工正在同步打卡数据: &#123;&#125;&quot;</span>, employeeId);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Map&lt;SyncTypeEnum, List&lt;ChannelCheckInDataResDto&gt;&gt; channelRecordsMap = channelRecords.stream().collect(Collectors.groupingBy(ChannelCheckInDataResDto::getChannel));</span><br><span class="line">            Map&lt;SyncTypeEnum, ChannelOriginRecordService&gt; channelServiceMap = syncClockInRecordFactory.getSyncChannelRecordsByChannels(channelRecordsMap.keySet());</span><br><span class="line">            List&lt;ClockInRecord&gt; clockInRecords = Lists.newArrayList();</span><br><span class="line">            <span class="keyword">for</span> (SyncTypeEnum channel : channelServiceMap.keySet()) &#123;</span><br><span class="line">                <span class="type">ChannelOriginRecordService</span> <span class="variable">originRecordService</span> <span class="operator">=</span> channelServiceMap.get(channel);</span><br><span class="line">                <span class="keyword">if</span> (Objects.isNull(originRecordService)) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;没有找到渠道对应的原始记录处理方式: &#123;&#125;, employeeUniqKey: &#123;&#125;&quot;</span>, channel, employeeUniqKey);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 处理原始数据</span></span><br><span class="line">                List&lt;ClockInRecord&gt; curChannelRecords = originRecordService.batchHandleOriginRecords(channelRecordsMap.getOrDefault(channel, Lists.newArrayList()));</span><br><span class="line">                clockInRecords.addAll(curChannelRecords);</span><br><span class="line">            &#125;</span><br><span class="line">            employeeUniqKeyRecordsMap.put(employeeUniqKey, clockInRecords);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;&#123;&#125;员工打卡数据同步失败&quot;</span>, employeeId, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (lock.isHeldByCurrentThread() &amp;&amp; lock.isLocked()) &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stopWatch.stop();</span><br><span class="line"></span><br><span class="line">    stopWatch.start(<span class="string">&quot;保存数据&quot;</span>);</span><br><span class="line">    transactionTemplate.execute(<span class="keyword">new</span> <span class="title class_">TransactionCallbackWithoutResult</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doInTransactionWithoutResult</span><span class="params">(TransactionStatus transactionStatus)</span> &#123;</span><br><span class="line">            List&lt;ClockInRecord&gt; totalRecords = employeeUniqKeyRecordsMap.values().stream().flatMap(Collection::stream).collect(Collectors.toList());</span><br><span class="line">            batchSaveClockRecords(totalRecords);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    stopWatch.stop();</span><br><span class="line"></span><br><span class="line">    stopWatch.start(<span class="string">&quot;推送消息&quot;</span>);</span><br><span class="line">    <span class="comment">// 推送相关消息处理后续业务</span></span><br><span class="line">    TransactionAsyncExecutor.asyncExecute(() -&gt; postHandleResult(employeeUniqKeyRecordsMap));</span><br><span class="line">    stopWatch.stop();</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">&quot;数据同步耗时：&#123;&#125;&quot;</span>, stopWatch.prettyPrint());</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>注意这一行代码,它会<strong>获取通道对应的原始打卡记录列表，这里获取的就是飞书</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;ClockInRecord&gt; curChannelRecords = originRecordService.batchHandleOriginRecords(channelRecordsMap.getOrDefault(channel, Lists.newArrayList()));</span><br></pre></td></tr></table></figure>





<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311232029497.png"></p>
<p>最后调用<code>larkService</code>下的<code>batchSave</code>方法，完成打卡记录的同步：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311232031789.png" alt="image-20231123203142111"></p>
<p>对应的<code>mapper</code>文件为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;batchInsert&quot;</span> <span class="attr">keyColumn</span>=<span class="string">&quot;id&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;map&quot;</span> <span class="attr">useGeneratedKeys</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  insert into hcm_abs_lark_origin_clock_record</span><br><span class="line">  (ent_id, bu_id, user_id, corp_id, employee_id, detail, lark_record_id, check_time, batch_number)</span><br><span class="line">  values</span><br><span class="line">  <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;list&quot;</span> <span class="attr">item</span>=<span class="string">&quot;item&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span>&gt;</span></span><br><span class="line">    (#&#123;item.entId&#125;, #&#123;item.buId&#125;, #&#123;item.userId&#125;, #&#123;item.corpId&#125;, #&#123;item.employeeId&#125;,</span><br><span class="line">    #&#123;item.detail&#125;, #&#123;item.larkRecordId&#125;, #&#123;item.checkTime&#125;, #&#123;item.batchNumber&#125;)</span><br><span class="line">  <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>数据库中的记录为：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311232036853.png" alt="image-20231123203601172"></p>
<h2 id="2、实时打卡—考勤机同步"><a href="#2、实时打卡—考勤机同步" class="headerlink" title="2、实时打卡—考勤机同步"></a>2、实时打卡—考勤机同步</h2><p>目前pp支持了两类考勤机：天敏考勤机、中控考勤机。两类考勤机在接入流程和数据交互流程上不全相同 </p>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="left">传输协议</th>
<th align="left">人脸检测</th>
<th align="left">人员下发</th>
<th align="left">打卡数据获取</th>
</tr>
</thead>
<tbody><tr>
<td align="left">天敏考勤机</td>
<td align="left">websocket(人员下发、心跳检测)+http(打卡数据上报)</td>
<td align="left">已接入</td>
<td align="left">考勤机逐个下发</td>
<td align="left">主动上报</td>
</tr>
<tr>
<td align="left">中控考勤机</td>
<td align="left">http</td>
<td align="left">暂未接入</td>
<td align="left">中控server下发</td>
<td align="left">主动定期拉取</td>
</tr>
</tbody></table>
<h3 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h3><p><strong>天敏考勤机服务架构图</strong>如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311241732116.png" alt="考勤机架构流程.drawio"></p>
<p>这里需要关注几个点：</p>
<ol>
<li>考勤机的鉴权：websocket的握手阶段(协议未升级前的步骤)可以拿到请求中传入的param,通过这个param我们可以对考勤机进行鉴权 –给每个住户分配一个key, 请求进来时，对key进行有效判断</li>
<li>怎么识别某个考勤机是哪个租户的？考勤机连接成功后，websocket会理解给考勤机发送一个deviceInfo的消息，deviceInfo的应答内容中有考勤机的mac地址，后台通过mac地址，识别出来这个考勤机是哪个租户的 。后续session回话管理会将mac地址和socket链接建立关系</li>
</ol>
<p>问题：</p>
<ol>
<li>目前线上和灰度是各自两台websocket, 通过上面的架构图可以看出，websocket server和gateway是长连接的形式： 如果有一台websocket server出现问题，websocket进行连接重建，出问题的那台websocket启动成功后，正常情况下是没有连接的 。线上暂时未发现这个情况出现，因为考勤机中断后，重新建立连接时，可以选择到其他的机器</li>
<li>考勤机天敏是支持http协议的，但是我们选择了websocket协议，这里的原因和背景是什么？ 如果使用http协议，考勤机需要提供一个可以被访问的外网地址，在使用场景下不太合适</li>
</ol>
<h3 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h3><p>天敏考勤机交互流程V1:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311241738503.png" alt="天敏考勤机交互流程.drawio"></p>
<p>天敏考勤机交互流程V2:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311241739243.png" alt="天敏考勤机流程梳理V2.drawio"></p>
<h2 id="3、实时打卡—Moka打卡"><a href="#3、实时打卡—Moka打卡" class="headerlink" title="3、实时打卡—Moka打卡"></a>3、实时打卡—Moka打卡</h2><p>MokaPeople 移动端打卡属于实时打卡的一种，旧的流程图如下所示：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311291725750.png" alt="移动端打卡"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041548328.png" alt="image-20231204154846112"></p>
<p>1.新的移动端实时打卡入口在<code>ClockOnPageController</code>内(&#x3D;&#x3D;&#x2F;v2&#x2F;m&#x2F;clockOn&#x3D;&#x3D;)：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041537220.png" alt="image-20231204153707026"></p>
<p>2.构建打卡上下文、选择对应的打卡Processor(WIFI、GPS、OutSide)、进入打卡核心流程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ClockOnResultDto <span class="title function_">clockOn</span><span class="params">(ClockOnReqV2Dto clockOnReqDto, Long entId, Long buId, Long employeeId)</span> &#123;</span><br><span class="line">       <span class="type">StopWatch</span> <span class="variable">stopWatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MokaStopWatch</span>(<span class="string">&quot;打卡接口&quot;</span>);</span><br><span class="line"></span><br><span class="line">       stopWatch.start(<span class="string">&quot;打卡上下文构建&quot;</span>);</span><br><span class="line">       <span class="type">ClockOnResultDto</span> <span class="variable">clockOnResultDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClockOnResultDto</span>();</span><br><span class="line">       <span class="type">Date</span> <span class="variable">attendanceDay</span> <span class="operator">=</span> clockOnReqDto.getAttendanceDay();</span><br><span class="line">       <span class="type">Date</span> <span class="variable">clockInTime</span> <span class="operator">=</span> DateTime.now().millisOfSecond().withMinimumValue().toDate();</span><br><span class="line">       <span class="type">ClockOnContext</span> <span class="variable">clockOnContext</span> <span class="operator">=</span> ClockOnContext.builder().entId(entId).buId(buId).employeeId(employeeId)</span><br><span class="line">               .attendanceDay(attendanceDay)</span><br><span class="line">               .needCheckOfficeStaff(<span class="literal">true</span>)</span><br><span class="line">               .macAddress(clockOnReqDto.getMacAddress())</span><br><span class="line">               .longitude(clockOnReqDto.getLongitude())</span><br><span class="line">               .latitude(clockOnReqDto.getLatitude())</span><br><span class="line">               .gpsAddress(clockOnReqDto.getGpsAddress())</span><br><span class="line">               .deviceId(clockOnReqDto.getDeviceId())</span><br><span class="line">               .description(clockOnReqDto.getDescription())</span><br><span class="line">               .attachment(clockOnReqDto.getAttachment())</span><br><span class="line">               .relatedRecordId(clockOnReqDto.getRelatedRecordId())</span><br><span class="line">               .relatedRecordType(clockOnReqDto.getRelatedRecordType())</span><br><span class="line">               .clockTime(clockInTime)</span><br><span class="line">               .sourceType(ClockRecordSourceTypeEnum.CLOCK.getValue())</span><br><span class="line">               .build();</span><br><span class="line"></span><br><span class="line">       List&lt;AbstractClockTypeProcessor&gt; processorList = Lists.newArrayList(wifiClockOn, gpsClockOn, outSideClockOn).stream().sorted(Comparator.comparing(AbstractClockTypeProcessor::sortOrder)).collect(toList());</span><br><span class="line">       <span class="type">AbstractClockTypeProcessor</span> <span class="variable">validProcessor</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">       stopWatch.stop();</span><br><span class="line"></span><br><span class="line">       stopWatch.start(<span class="string">&quot;打卡处理器执行&quot;</span>);</span><br><span class="line">       <span class="keyword">for</span> (AbstractClockTypeProcessor processor : processorList) &#123;</span><br><span class="line">           <span class="keyword">if</span> (!processor.ruleOpen(clockOnContext)) &#123;</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (!processor.isValid(clockOnContext)) &#123;</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           validProcessor = processor;</span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       stopWatch.stop();</span><br><span class="line"></span><br><span class="line">       stopWatch.start(<span class="string">&quot;打卡核心流程&quot;</span>);</span><br><span class="line">       <span class="keyword">if</span> (validProcessor != <span class="literal">null</span>) &#123;</span><br><span class="line">           addClockRecordAndPushSuccessNotify(clockOnContext, validProcessor);</span><br><span class="line">           clockOnResultDto.setClockInTime(clockInTime);</span><br><span class="line">           clockOnResultDto.setClockOnStatus(<span class="literal">true</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           clockOnResultDto.setClockInTime(<span class="literal">null</span>);</span><br><span class="line">           clockOnResultDto.setClockOnStatus(<span class="literal">false</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       stopWatch.stop();</span><br><span class="line">       log.info(stopWatch.prettyPrint());</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> clockOnResultDto;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<p>3.(<code>addClockRecordAndPushSuccessNotify(clockOnContext, validProcessor)</code>)添加打卡记录，并发送成功消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加打卡记录，并发送成功消息</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> clockOnContext</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> processor</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addClockRecordAndPushSuccessNotify</span><span class="params">(ClockOnContext clockOnContext, AbstractClockTypeProcessor processor)</span> &#123;</span><br><span class="line">    <span class="type">StopWatch</span> <span class="variable">stopWatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StopWatch</span>(<span class="string">&quot;移动端打卡&quot;</span>);</span><br><span class="line">    <span class="type">Long</span> <span class="variable">entId</span> <span class="operator">=</span> clockOnContext.getEntId();</span><br><span class="line">    <span class="type">Long</span> <span class="variable">buId</span> <span class="operator">=</span> clockOnContext.getBuId();</span><br><span class="line">    <span class="type">Long</span> <span class="variable">employeeId</span> <span class="operator">=</span> clockOnContext.getEmployeeId();</span><br><span class="line">    <span class="type">Date</span> <span class="variable">attendanceDay</span> <span class="operator">=</span> clockOnContext.getAttendanceDay();</span><br><span class="line"></span><br><span class="line">    stopWatch.start(<span class="string">&quot;记录打卡记录&quot;</span>);</span><br><span class="line">    processor.addClockRecord(clockOnContext);</span><br><span class="line">    stopWatch.stop();</span><br><span class="line"></span><br><span class="line">    stopWatch.start(<span class="string">&quot;rpc触发打卡考勤核算&quot;</span>);</span><br><span class="line">    attendanceRecordV2Service.clockCalculate(entId, buId, employeeId, attendanceDay);</span><br><span class="line">    stopWatch.stop();</span><br><span class="line"></span><br><span class="line">    stopWatch.start(<span class="string">&quot;发送打卡成功异步通知&quot;</span>);</span><br><span class="line">    <span class="type">ClockSuccessNotifyContext</span> <span class="variable">clockSuccessNotifyContext</span> <span class="operator">=</span> ClockSuccessNotifyContext.buildClockRecordContextFromClockOnAction(clockOnContext);</span><br><span class="line">    clockNoticeMsgPushService.asyncPushClockSuccessNotify(clockSuccessNotifyContext);</span><br><span class="line">    stopWatch.stop();</span><br><span class="line"></span><br><span class="line">    log.info(stopWatch.prettyPrint());</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一步骤主要做了三件事：</p>
<h4 id="打卡记录入库-事务保证Moka打卡表数据和打卡总表数据一致性"><a href="#打卡记录入库-事务保证Moka打卡表数据和打卡总表数据一致性" class="headerlink" title="打卡记录入库(事务保证Moka打卡表数据和打卡总表数据一致性)"></a>打卡记录入库(事务保证Moka打卡表数据和打卡总表数据一致性)</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041556776.png" alt="image-20231204155642559"></p>
<p>​    录入 moka people 原始打卡记录表<code>hcm_abs_moka_clock_record</code>:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041604905.png" alt="image-20231204160401684">   </p>
<p>​    录入打卡记录总表 <code>hcm_abs_clock_in_record</code>:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041608682.png" alt="image-20231204160825399"></p>
<h4 id="RPC-触发打卡考勤核算-加入判断核算降级逻辑-："><a href="#RPC-触发打卡考勤核算-加入判断核算降级逻辑-：" class="headerlink" title="RPC 触发打卡考勤核算(加入判断核算降级逻辑)："></a>RPC 触发打卡考勤核算(加入判断核算降级逻辑)：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clockCalculate</span><span class="params">(Long entId, Long buId, Long employeeId, Date attendanceDay)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//降级模式</span></span><br><span class="line">    <span class="type">DegradationModelEnum</span> <span class="variable">degradationModel</span> <span class="operator">=</span> imitateClockFailedBackHandler.degradationModel();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(degradationModel == DegradationModelEnum.ACTIVE)&#123;</span><br><span class="line">            log.info(<span class="string">&quot;打卡实时核算主动触发降级,entId:&#123;&#125;,employeeId:&#123;&#125;&quot;</span>,entId,employeeId);</span><br><span class="line">            <span class="comment">// 发送考勤核算消息</span></span><br><span class="line">            Period&lt;Day&gt; period = Period.between(Day.of(attendanceDay), Day.of(attendanceDay));</span><br><span class="line">            <span class="type">BatchCalculateMessageDto</span> <span class="variable">batchCalculateMessageDto</span> <span class="operator">=</span> BatchCalculateMessageDto</span><br><span class="line">                    .buildBatchCalculateMessage(Tenant.of(entId, buId), period, Lists.newArrayList(employeeId));</span><br><span class="line">            clockInRecordAddMsgProducer.pushBatchCalculateMsg(batchCalculateMessageDto);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="type">ClockCalculateDto</span> <span class="variable">clockCalculateDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClockCalculateDto</span>();</span><br><span class="line">            clockCalculateDto.setEntId(entId);</span><br><span class="line">            clockCalculateDto.setBuId(buId);</span><br><span class="line">            clockCalculateDto.setEmployeeId(employeeId);</span><br><span class="line">            clockCalculateDto.setWorkflowStatusList(Lists.newArrayList(WorkflowStatusEnum.APPROVED));</span><br><span class="line">            clockCalculateDto.setCalculateDate(attendanceDay);</span><br><span class="line">            clockCalculateDto.setUid(employeeId);</span><br><span class="line">            clockCalculateDto.setSourceType(AttendanceCalculateSourceTypeEnum.CLOCK);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 触发打卡实时核算</span></span><br><span class="line">            <span class="type">ResultDto</span> <span class="variable">clockCalculateResult</span> <span class="operator">=</span> attendanceCalculateClient.clockCalculate(clockCalculateDto);</span><br><span class="line">            <span class="keyword">if</span> (clockCalculateResult == <span class="literal">null</span> || !clockCalculateResult.success()) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;clockCalculate failed, param:&#123;&#125;, result:&#123;&#125;&quot;</span>, JacksonUtils.toJson(clockCalculateDto), JacksonUtils.toJson(clockCalculateResult));</span><br><span class="line">                <span class="comment">//如果实时打卡核算失败，抛异常走降级</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CustomException</span>(<span class="string">&quot;打卡核算失败&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.warn(<span class="string">&quot;考勤核算失败 entId:&#123;&#125;, employeeId:&#123;&#125;,attendanceDay:&#123;&#125;&quot;</span>, entId, employeeId, attendanceDay, e);</span><br><span class="line">        <span class="keyword">if</span>(degradationModel == DegradationModelEnum.PASSIVE)&#123;</span><br><span class="line">            log.error(<span class="string">&quot;调用实时考勤核算报错，被动降级模式，触发降级&quot;</span>);</span><br><span class="line">            <span class="comment">// 发送考勤核算消息</span></span><br><span class="line">            Period&lt;Day&gt; period = Period.between(Day.of(attendanceDay).add(-<span class="number">1</span>), Day.of(attendanceDay).add(<span class="number">1</span>));</span><br><span class="line">            <span class="type">BatchCalculateMessageDto</span> <span class="variable">batchCalculateMessageDto</span> <span class="operator">=</span> BatchCalculateMessageDto.builder()</span><br><span class="line">                    .entId(entId)</span><br><span class="line">                    .buId(buId)</span><br><span class="line">                    .employeeIdList(Lists.newArrayList(employeeId))</span><br><span class="line">                    .beginDate(period.getStart().toDate())</span><br><span class="line">                    .endDate(period.getEnd().toDate())</span><br><span class="line">                    .sourceType(AttendanceCalculateSourceTypeEnum.CLOCK_MOKA)</span><br><span class="line">                    .triggerOverTime(<span class="literal">true</span>)</span><br><span class="line">                    .uid(<span class="number">1L</span>)  <span class="comment">// 1表示系统触发的核算</span></span><br><span class="line">                    .build();</span><br><span class="line">            clockInRecordAddMsgProducer.pushBatchCalculateMsg(batchCalculateMessageDto);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>判断降级后会发送<code>kafka</code>消息：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041630404.png" alt="image-20231204163018146"></p>
<p><code>hcm-attendance</code> 接收消息进行考勤批量核算：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041633826.png" alt="image-20231204163320564"></p>
<blockquote>
<p>Tips：降级模式下的核算与非降级模式下的核算逻辑区别在哪里🧐?</p>
</blockquote>
<p>如果走降级：则发送一个<code>kafka</code>消息至指定<code>topic</code>，并不关注什么下游消费者时候消费</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041925018.png" alt="image-20231204192546711"></p>
<p>如果不走降级模式：则执行实时核算：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041928504.png" alt="image-20231204192811184"></p>
<p>那么如何判断该走 降级&#x2F;非降级 链路呢？</p>
<p>在下列<code>degradationModel</code>方法中，首先尝试从配置中心获取打卡降级模式的配置项值。它使用了<code>MokaConfig.getInstance().getPropertyFromDefault</code>方法，该方法会尝试从配置中心获取名为<code>CLOCK_DEGRADATION_MODEL</code>的配置项的值。如果获取失败，则默认为被动降级模式（<code>DegradationModelEnum.PASSIVE</code>）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//降级模式</span></span><br><span class="line"><span class="type">DegradationModelEnum</span> <span class="variable">degradationModel</span> <span class="operator">=</span> imitateClockFailedBackHandler.degradationModel();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 降级模式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">public</span> DegradationModelEnum <span class="title function_">degradationModel</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//return DegradationModelEnum.parse(this.clockDegradationModel);</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">degradationModel</span> <span class="operator">=</span> MokaConfig.getInstance().getPropertyFromDefault(CLOCK_DEGRADATION_MODEL, String.class, DegradationModelEnum.PASSIVE.name());</span><br><span class="line">    <span class="keyword">return</span> DegradationModelEnum.parse(degradationModel);</span><br><span class="line">  &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">    log.error(<span class="string">&quot;查询打卡降级模式失败，默认关闭降级&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> DegradationModelEnum.OFF;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>apollo配置如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041953186.png" alt="image-20231204195330851"></p>
<p>可以看出 Key 为<code>CLOCK_DEGRADATION_MODEL</code>对应的 Value 默认值为 <strong>Passive ——被动降级</strong>，因此只有在远程调用<code>attendanceCalculateClient.clockCalculate()</code>异常时，会捕捉异常catch代码块执行降级逻辑：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041958317.png" alt="image-20231204195835988"></p>
<h4 id="发送打卡成功异步通知"><a href="#发送打卡成功异步通知" class="headerlink" title="发送打卡成功异步通知"></a>发送打卡成功异步通知</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clockNoticeMsgPushService.asyncPushClockSuccessNotify(clockSuccessNotifyContext);</span><br></pre></td></tr></table></figure>



<p>发送打卡成功通知时通过自定义线程池来发送：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041641050.png" alt="image-20231204164153738"></p>
<p>推送消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 推送打卡成功通知</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> clockSuccessNotifyContext 打卡记录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">asyncPushClockSuccessNotify</span><span class="params">(ClockSuccessNotifyContext clockSuccessNotifyContext)</span> &#123;</span><br><span class="line">    CLOCK_SUCCESS_NOTICE_MSG_SEND_THREAD_POOL.execute(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Long</span> <span class="variable">entId</span> <span class="operator">=</span> clockSuccessNotifyContext.getEntId();</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isOff</span> <span class="operator">=</span> ApolloUtil.isClockSuccessNotifySwitchIsOff(entId);</span><br><span class="line">            <span class="keyword">if</span> (isOff) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;当前租户打卡成功提醒已关闭, entId:&#123;&#125;&quot;</span>, entId);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            log.info(<span class="string">&quot;打卡记录推送打卡成功提醒通知 record : &#123;&#125;&quot;</span>, clockSuccessNotifyContext.toString());</span><br><span class="line">            <span class="comment">//发送打卡记录校验提醒</span></span><br><span class="line">            <span class="keyword">for</span> (ClockSuccessNotifyCheck clockSuccessNotifyCheck : clockNotifyCheckList) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!clockSuccessNotifyCheck.verifyNeedNotify(clockSuccessNotifyContext)) &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;打卡成功提醒校验失败，不发送打卡通知&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            log.info(<span class="string">&quot;员工打卡成功推送打卡成功消息 pushClockSuccessNotify  entId :&#123;&#125;, bu:&#123;&#125;, uid:&#123;&#125;&quot;</span>, clockSuccessNotifyContext.getEntId(), clockSuccessNotifyContext.getBuId(), clockSuccessNotifyContext.getEmployeeId());</span><br><span class="line">            <span class="type">PushMsg</span> <span class="variable">pushMsg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PushMsg</span>();</span><br><span class="line">          </span><br><span class="line">            <span class="comment">//根据打卡记录生成打卡成功通知title</span></span><br><span class="line">            pushMsg.setTitle(generateClockTitle(clockSuccessNotifyContext));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//根据打卡记录生成打卡发送通知内容</span></span><br><span class="line">            pushMsg.setMsg(generateClockMsg(clockSuccessNotifyContext));</span><br><span class="line">            pushMsg.setMsgType(PushMsg.TYPE_CLOCK_NOTICE);</span><br><span class="line">            pushMsg.setMsgOrigId(<span class="number">0L</span>);</span><br><span class="line">            <span class="comment">// 接收消息的用户</span></span><br><span class="line">            pushMsg.setMsgTargIdList(Collections.singletonList(clockSuccessNotifyContext.getEmployeeId()));</span><br><span class="line">            pushMsg.setMsgId(PushMsgKeyUtil.generateKeyWithSnowFlake());</span><br><span class="line">            pushMsg.setEntId(clockSuccessNotifyContext.getEntId().intValue());</span><br><span class="line">            pushMsg.setBuId(clockSuccessNotifyContext.getBuId().intValue());</span><br><span class="line">            pushMsg.setCreateTime(System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">            <span class="type">EmployeeAttendanceRuleDetailDto</span> <span class="variable">attendanceRuleDetailDto</span> <span class="operator">=</span> clockSuccessNotifyContext.getAttendanceRuleDetailDto();</span><br><span class="line">            <span class="type">AttendanceRuleClockDto</span> <span class="variable">clockDto</span> <span class="operator">=</span> attendanceRuleDetailDto.getClockInfo();</span><br><span class="line">            <span class="keyword">if</span> (clockDto.getIsNeedClock() || clockDto.getIsAllowOutsideClock()) &#123;</span><br><span class="line">                pushMsg.setHaveRedirectUrl(<span class="literal">true</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                pushMsg.setHaveRedirectUrl(<span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> Message.builder()</span><br><span class="line">                    .topic(topic)</span><br><span class="line">                    .body(JacksonUtils.toJson(pushMsg))</span><br><span class="line">                    .build();</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">pushFlag</span> <span class="operator">=</span> defaultMsgProducer.pushMsg(message);</span><br><span class="line">            <span class="keyword">if</span> (pushFlag) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;打卡成功消息推送kafka success pushClockSuccessNotify msg =&#123;&#125;&quot;</span>, JacksonUtils.toJson(message));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;打卡成功消息推送kafka失败 pushClockSuccessNotify msg =&#123;&#125;&quot;</span>, JacksonUtils.toJson(message));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;打卡记录推送打卡成功提醒通知失败, record : &#123;&#125;&quot;</span>, JacksonUtils.toJson(clockSuccessNotifyContext), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>













<h1 id="打卡链路优化"><a href="#打卡链路优化" class="headerlink" title="打卡链路优化"></a>打卡链路优化</h1><h2 id="背景与问题"><a href="#背景与问题" class="headerlink" title="背景与问题"></a>背景与问题</h2><p>目前打卡是假勤里面用的最多的一个业务，加班、考勤核算、出差、外出都可能会用打卡作为基础数据，所以打卡数据能及时同步、员工打卡动作能快速流畅的完成，对系统业务功能和用户体验非常重要。</p>
<p>但目前我们系统打卡还存在一定问题，主要是（划线的本次方案未解决）：</p>
<p>1、员工打卡的时候由于<code>attendance</code>服务的压力，有可能模拟核算失败，员工打不了卡（移动端考勤核算速度慢）</p>
<p>2、<strong>同步打卡数据后发考勤核算消息是一条一条发的，增加了attendance服务的核算压力；校验是否已落库按单条记录加锁，效率低</strong>（&#x3D;&#x3D;同步打卡优化&#x3D;&#x3D;）</p>
<p><del>3、同步打卡的数据源应用限流，导致我们打卡数据不能及时同步（&#x3D;&#x3D;同步打卡优化&#x3D;&#x3D;）</del></p>
<p><del>4、如果员工在第三方应用补卡，超过我们最大同步时间，同步不了打卡数据（同步，当前超过x分钟也同步不过来）</del></p>
<p><del>5、入职未绑定到第三方应用或离职员工打卡同步不过来（同步，受第三方应用限制）</del></p>
<p>6、openapi没有来源方式字段（需求）</p>
<p>7、员工打卡调用了太多次考勤规则，absence服务压力增大(&#x3D;&#x3D;实时打卡优化&#x3D;&#x3D;)</p>
<h2 id="原来流程"><a href="#原来流程" class="headerlink" title="原来流程"></a>原来流程</h2><p><strong>1、同步打卡流程</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311281950041.png" alt="image-20231128195002904"></p>
<p>2、实时打卡链路优化</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311281948030.png" alt="image-20231128194850890"></p>
<h2 id="优化方案-star2"><a href="#优化方案-star2" class="headerlink" title="优化方案 :star2:"></a>优化方案 :star2:</h2><h3 id="1、同步打卡流程优化"><a href="#1、同步打卡流程优化" class="headerlink" title="1、同步打卡流程优化 "></a><strong>1、同步打卡流程优化</strong> <a name="syncOptimize"></a></h3><p>解决<strong>同步单条处理，无法批量合并发送考勤核算问题</strong></p>
<p>优化预期效果：</p>
<p>  1）调用第三方接口的次数减少，降低限流概率</p>
<p>  2）按员工id指定分区发送打卡数据，减少锁冲突，批量处理数据，提高处理效率</p>
<p>  3）合并打卡触发考勤核算消息，增加考勤核算效率</p>
<p>  4）同步打卡入口都用同一套逻辑，方便维护</p>
<p>1.1 总览：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311281950808.png" alt="image-20231128195049663"></p>
<p>1.2 修改的功能点</p>
<table>
<thead>
<tr>
<th align="left">功能点</th>
<th align="left">所属服务</th>
</tr>
</thead>
<tbody><tr>
<td align="left">mobile 单机限流改成分布式，所有实例统一控制</td>
<td align="left">mobile</td>
</tr>
<tr>
<td align="left">同步打卡数据按employeeId分组，并按employeeId批量分发到指定分区，使用新的topic</td>
<td align="left">mobile</td>
</tr>
<tr>
<td align="left">回调结果增加缓存队列，10S或20条数据批量查询第三方打卡记录，并按employeeId批量分发到指定分区，使用新的topic</td>
<td align="left">mobile</td>
</tr>
<tr>
<td align="left">同步打卡处理流程处理，从新topic取打卡数据，按员工批量处理(加锁、落库等)</td>
<td align="left">clock</td>
</tr>
<tr>
<td align="left">发送考勤核算消息优化，同一个员工连续多天的打卡记录合并成一条考勤核算消息，多个员工的考勤核算消息批量发送，使用新的topic</td>
<td align="left">clock</td>
</tr>
<tr>
<td align="left">消费考勤核算消息修改，消费新的topic消息</td>
<td align="left">attendance</td>
</tr>
</tbody></table>
<p>每个功能点对应的代码块为：</p>
<h4 id="限流优化"><a href="#限流优化" class="headerlink" title="限流优化"></a>限流优化</h4><p><strong>(1) 更改为分布式限流统一控制所有实例：</strong></p>
<p>Before: 先来看看旧方案的处理方式(基于Guava的单机限流)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311301305215.png" alt="image-20231130130544775"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 钉钉签到接口限流 ——version1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DING_RATE_LIMIT_COUNT</span> <span class="operator">=</span> <span class="number">19</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dingCheckinAcquireByCorpId</span><span class="params">(String corpId)</span>&#123;</span><br><span class="line">    <span class="comment">// 钉钉签到单机限流，每S 40个 两台机子 每个19 防止跑满</span></span><br><span class="line">    <span class="type">RateLimiter</span> <span class="variable">rateLimiter</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (absDingCheckinLimiterMap.containsKey(corpId)) &#123;</span><br><span class="line">        rateLimiter = absDingCheckinLimiterMap.get(corpId);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        rateLimiter = RateLimiter.create(DING_RATE_LIMIT_COUNT);</span><br><span class="line">        absDingCheckinLimiterMap.put(corpId, rateLimiter);</span><br><span class="line">    &#125;</span><br><span class="line">    rateLimiter.acquire();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="meta">@CanIgnoreReturnValue</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">acquire</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">----------------</span><br><span class="line">  </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 钉钉签到接口限流  ——version2</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dingCheckinAcquireByCorpId</span><span class="params">(String corpId)</span>&#123;</span><br><span class="line">        <span class="type">RRateLimiter</span> <span class="variable">rRateLimiter</span> <span class="operator">=</span> redissonClient.getRateLimiter(<span class="string">&quot;mobile:limiter:ding:checkin:&quot;</span> + corpId);</span><br><span class="line">        rRateLimiter.trySetRate(RateType.OVERALL,<span class="number">40</span>,<span class="number">1</span>, RateIntervalUnit.SECONDS);</span><br><span class="line">        rRateLimiter.acquire();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 钉钉签到接口限流  ——version3</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dingCheckinAcquireByCorpId</span><span class="params">(String corpId)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;mobile:limiter:ding:checkin:&quot;</span> + corpId;</span><br><span class="line">        log.info(<span class="string">&quot;dingCheckinAcquireByCorpId:&#123;&#125; &quot;</span>, key);</span><br><span class="line">        redisLimitTemplate.initRateLimiter(key, <span class="number">40</span> - LIMIT_BUFFER, <span class="number">1</span>, RateIntervalUnit.SECONDS);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">acquire</span> <span class="operator">=</span> redisLimitTemplate.tryAcquire(key, <span class="number">3</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">if</span> (!acquire) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CustomException</span>(<span class="string">&quot;请求被限流控制，请稍后重试&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>对应的<code>RedisLimitTemplate</code>类代码为：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311301427513.png" alt="image-20231130142705047"></p>
<p>Now: 更改为分布式限流</p>
<ul>
<li><input disabled="" type="checkbox"> Lark限流：</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311291934382.png" alt="image-20231129193438686"></p>
<ul>
<li><input disabled="" type="checkbox"> 企业微信限流：</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311291936572.png" alt="image-20231129193607884"></p>
<ul>
<li><input disabled="" type="checkbox"> DingDing限流: 同理</li>
</ul>
<h4 id="合并发送消息处理、加锁落库"><a href="#合并发送消息处理、加锁落库" class="headerlink" title="合并发送消息处理、加锁落库"></a>合并发送消息处理、加锁落库</h4><p><strong>(2) 将打卡数据按照员工id分组，批量分发、接收消息</strong></p>
<ul>
<li><p><input disabled="" type="checkbox"> 
分发消息：<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311291931698.png" alt="image-20231129193114998"></p>
</li>
<li><p><input disabled="" type="checkbox"> 
接收消息：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311291933159.png" alt="image-20231129193317457"></p>
</li>
</ul>
<p>(3) &#x3D;&#x3D;回调结果增加缓存队列&#x3D;&#x3D;</p>
<ul>
<li>对应的放到topic可以理解为缓存</li>
<li>调用它的地方就类似于本地缓存了，其实就是批量查询</li>
</ul>
<p>(4)同步打卡处理流程处理，从新topic取打卡数据，按员工批量处理(<strong>加锁、落库</strong>等):</p>
<p>路径为 <code>BatchSyncChannelRecordServiceImpl#handleChannelRecords</code> 方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311301437834.png" alt="image-20231130143745312"></p>
<p>(5)<code>hcm-absence-attendance</code>增加批量触发核算消息：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041410027.png" alt="image-20231204141018839"></p>
<h3 id="2、实时打卡链路优化"><a href="#2、实时打卡链路优化" class="headerlink" title="2、实时打卡链路优化"></a><strong>2、实时打卡链路优化</strong></h3><p>解决模拟核算失败，无法打卡，考勤规则调用频繁响应慢的问题</p>
<p>优化预期效果：打卡调用模拟核算接口次数减少、attendance服务挂了或者报错员工仍能正常打卡、查询考勤规则接口响应更快</p>
<p><strong>2.1 总览：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311291951824.png" alt="image-20231129195131544"></p>
<h4 id="服务降级"><a href="#服务降级" class="headerlink" title="服务降级"></a>服务降级</h4><table>
<thead>
<tr>
<th align="left">接口</th>
<th align="left">描述</th>
<th align="left">降级</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>/api/abs/clock/clockOnPage/v2/m/clockOn</code></td>
<td align="left">打卡的时候实时核算，异步通知</td>
<td align="left">发送核算消息</td>
</tr>
<tr>
<td align="left"><code>/api/abs/clock/clockOnPage/v2/m/clockOutCheck</code></td>
<td align="left">打下班卡的时候先提前检查一下是否会签退异常，提示用户</td>
<td align="left">不处理（当上面两个接口降级成无班次之后不会调用这个接口）</td>
</tr>
<tr>
<td align="left"><code>/api/abs/clock/clockOnPage/v2/m/queryClockRecord</code></td>
<td align="left">查询打卡记录，标记是签到或签退卡</td>
<td align="left">同上</td>
</tr>
<tr>
<td align="left"><code>/api/abs/clock/clockOnPage/v2/m/queryRuleAndAttendanceInfo</code></td>
<td align="left">查询班次信息、打卡时间信息、考勤规则等</td>
<td align="left">按无班次处理，clock内部按无班次模拟模算复制一份代码</td>
</tr>
<tr>
<td align="left"><code>/api/abs/clock/clockOnPage/v2/m/refreshGps</code></td>
<td align="left">刷新gps信息，会调考勤规则，触发自动打卡</td>
<td align="left">不处理</td>
</tr>
<tr>
<td align="left"><code>/api/abs/clock/clockOnPage/v2/m/refreshWifi</code></td>
<td align="left">刷新wifi信息，会调考勤规则，触发自动打卡</td>
<td align="left">不处理</td>
</tr>
</tbody></table>
<p><strong>2.3 接口合并：</strong></p>
<p><code>queryRuleAndAttendanceInfo</code> 和 <code>queryClockRecord</code> 接口合并成一个接口返回给前端</p>
<h4 id="考勤规则接口缓存"><a href="#考勤规则接口缓存" class="headerlink" title="考勤规则接口缓存"></a>考勤规则接口缓存</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311281957236.png" alt="考勤规则缓存111.drawio"></p>
<p>由于在进行考勤核算时，需要查询员工对应考勤规则(hcm-absence下):</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041722302.png" alt="image-20231204172235931"></p>
<p>判断考勤规则数据是否命中、及是否需要加入缓存：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041727855.png" alt="image-20231204172714517"></p>
<p>着重来看一下缓存相关逻辑</p>
<p>1、从缓存中查询规则信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 从缓存中查询规则信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> start</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> employeeIds</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> entId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> null 表示缓存中没有数据，或者缓存中数据已是过期数据，需要重新从db查询</span></span><br><span class="line"><span class="comment"> *         如果返回结果不为空，即使是个空数组，也不用从db查询（为空数组说明这几天确实就是没有配置考勤规则）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> List&lt;EmployeeAttendanceRuleDetailDto&gt; <span class="title function_">queryRuleFromCache</span><span class="params">(LocalDate start,LocalDate end,<span class="type">int</span> attrType,List&lt;Long&gt; employeeIds,Long entId)</span>&#123;</span><br><span class="line">    <span class="comment">//构造缓存key</span></span><br><span class="line">    List&lt;String&gt; keys = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;LocalDate&gt; dateList = <span class="built_in">this</span>.getDates(start,end);</span><br><span class="line">    dateList.forEach(date -&gt; &#123;</span><br><span class="line">        employeeIds.forEach(employeeId -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> getDetailCacheKey(entId,employeeId,date);</span><br><span class="line">            keys.add(key);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//批量查询结果</span></span><br><span class="line">    List&lt;String&gt; resStrs = redisTemplate.opsForValue().multiGet(keys);</span><br><span class="line">    <span class="keyword">if</span>(CollectionUtils.isEmpty(resStrs))&#123;</span><br><span class="line">        <span class="comment">//缓存中如果没有数据，返回空，触发从库中查询</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    resStrs = resStrs.stream().filter(e -&gt; Objects.nonNull(e)).collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">if</span>(resStrs.size()!=keys.size())&#123;</span><br><span class="line">        <span class="comment">//数据条数和请求的条数对不上，说明没有缓存或缓存已过期了，返回空，触发从库中查询</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;EmployeeAttendanceRuleDetailDto&gt; ruleDtailList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span>(String resStr:resStrs)&#123;</span><br><span class="line">        <span class="comment">//当天有考勤规则才转成对像</span></span><br><span class="line">        <span class="keyword">if</span>(!NONE_RULE.equals(resStr))&#123;</span><br><span class="line">            <span class="type">EmployeeAttendanceRuleDetailDto</span> <span class="variable">detailDto</span> <span class="operator">=</span> JacksonUtils.fromJson(resStr,EmployeeAttendanceRuleDetailDto.class);</span><br><span class="line">            ruleDtailList.add(dealRuleDetailDto(detailDto,attrType));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    log.info(<span class="string">&quot;从缓存中查询考勤规则详情,employeeIds:&#123;&#125;,start:&#123;&#125;,end:&#123;&#125;&quot;</span>,employeeIds,DateUtils.format(start.toDate(),DatePattern.YMD),DateUtils.format(end.toDate(),DatePattern.YMD));</span><br><span class="line">    <span class="keyword">return</span> ruleDtailList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>2、将员工加入到缓存队列</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">        param.getEmployeeIds().forEach(employeeId -&gt; &#123;</span><br><span class="line">            <span class="type">AddCacheMsg</span> <span class="variable">msg</span> <span class="operator">=</span> AddCacheMsg.builder().employeeId(employeeId).entId(entId).buId(buId).build();</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">res</span> <span class="operator">=</span> redisListTool.sendMsgToList(CacheConstants.getAddCacheQueueName(),JacksonUtils.toJson(msg),String.valueOf(employeeId));</span><br><span class="line">            <span class="keyword">if</span>(!res)&#123;</span><br><span class="line">                log.warn(<span class="string">&quot;员工加缓存失败:&#123;&#125;&quot;</span>,employeeId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">sendMsgToList</span><span class="params">(String name, String msg, String key)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(name) &amp;&amp; !StringUtils.isEmpty(key) &amp;&amp; !StringUtils.isEmpty(msg)) &#123;</span><br><span class="line">        <span class="comment">// 检查消息是否已存在于Redis中</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">existed</span> <span class="operator">=</span> <span class="built_in">this</span>.redisTemplate.opsForSet().isMember(<span class="string">&quot;hcm:absence:queue:&quot;</span> + name + <span class="string">&quot;_unique&quot;</span>, key);</span><br><span class="line">        <span class="keyword">if</span> (existed != <span class="literal">null</span> &amp;&amp; existed) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;消息已在Redis中存在，不发送&quot;</span>);</span><br><span class="line">            CountStatisticUtil.increment(<span class="string">&quot;msgExisted&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 将消息推送到Redis队列</span></span><br><span class="line">            <span class="type">Long</span> <span class="variable">res</span> <span class="operator">=</span> <span class="built_in">this</span>.redisTemplate.opsForList().leftPush(<span class="string">&quot;hcm:absence:queue:&quot;</span> + name, JSONObject.toJSONString(<span class="keyword">new</span> <span class="title class_">RedisQueueMsg</span>(key, msg)));</span><br><span class="line">            <span class="keyword">if</span> (res != <span class="literal">null</span> &amp;&amp; res &gt; <span class="number">0L</span>) &#123;</span><br><span class="line">                <span class="comment">// 将消息的唯一标识加入Redis集合</span></span><br><span class="line">                <span class="built_in">this</span>.redisTemplate.opsForSet().add(<span class="string">&quot;hcm:absence:queue:&quot;</span> + name + <span class="string">&quot;_unique&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;key&#125;);</span><br><span class="line">                <span class="comment">// 发送通知，通知消费者有新消息</span></span><br><span class="line">                <span class="built_in">this</span>.redisTemplate.convertAndSend(<span class="built_in">this</span>.config.getNoticeChannel(), name);</span><br><span class="line">                CountStatisticUtil.increment(<span class="string">&quot;sendSuccess&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        CountStatisticUtil.increment(<span class="string">&quot;emptyMsg&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h4 id="考勤规则降级设计"><a href="#考勤规则降级设计" class="headerlink" title="考勤规则降级设计"></a>考勤规则降级设计</h4><p><strong>一、降级方案图示</strong></p>
<p><strong>降级的打卡记同步到正常打卡记录表生命周期：入库 → 验证有效状态 → 同步</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312211805097.png" alt="考勤规则降级.drawio"></p>
<p><strong>改动点说明：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312211806926.png" alt="image-20231221180646741"></p>
<p><strong>二、验证流程</strong></p>
<p>验证流程只做验证，不做同步</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312211807932.png" alt="验证流程.drawio"></p>
<p><strong>三、同步流程</strong></p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312211808510.png" alt="image-20231221180807325" style="zoom:50%;" />







<h3 id="3、打卡分表"><a href="#3、打卡分表" class="headerlink" title="3、打卡分表"></a><strong>3、打卡分表</strong></h3><p>方案一： 按租户分表</p>
<p>配置里配置哪些租户需要单独分表，剩下租户使用原表；</p>
<p>当配置了租户分表后调用接口初始化租户的打卡表，然后迁移租户数据到目的表中；</p>
<p>打卡的<code>crud</code>通过<code>mybatis</code>插件修改表名，指向目标表；</p>
<p>优势：</p>
<p>1、可以根据租户打卡数据量来确定是否需要分到单独的表，或者把几个租户合到一个表里面，防止有的表数据多，有的表数据少，也可以把重点租户单独拉出来</p>
<p>2、同一个租户的数据在一个表中，对于业务查询或落库无任何影响，业务契合度很高，基本上不需要上层改动什么代码。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311281958881.png" alt="image-20231128195839733"></p>
<p>方案二： 按时间分表</p>
<p>2个月一张表，一张表数据量控制在500W以下，定时任务创建未来的表，分库分表框加处理数据库请求</p>
<p>优势：不需要人为干预分表，每个表的数据也比较均衡，但如果跨表查询可能比较麻烦点</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311281959086.png" alt="image-20231128195923933"></p>
<h2 id="打卡故障复盘"><a href="#打卡故障复盘" class="headerlink" title="打卡故障复盘"></a>打卡故障复盘</h2><h3 id="事故来龙去脉"><a href="#事故来龙去脉" class="headerlink" title="事故来龙去脉"></a>事故来龙去脉</h3><p><strong>影响范围：</strong></p>
<ul>
<li>业务影响：<ul>
<li>受影响的业务场景 &amp; 严重程度： 天九共享、浙江医学科技开发有限公司、迈格森等部分员工打不了卡</li>
</ul>
</li>
<li>量化影响：<ul>
<li>影响的客户数量： 3家客户提报</li>
<li>影响的数据量：</li>
<li>影响时间：<strong>2023-03-10 17:36~2023-03-10 17:41（从出错的日志看）</strong></li>
</ul>
</li>
</ul>
<p>页面显示：</p>
<p>1、打卡页面提示错误，无法打卡</p>
<p>2、进不去打卡页面</p>
<p>影响租户：</p>
<table>
<thead>
<tr>
<th align="left">租户</th>
</tr>
</thead>
<tbody><tr>
<td align="left">天九共享</td>
</tr>
<tr>
<td align="left">浙江医学科技开发有限公司</td>
</tr>
<tr>
<td align="left">成都迈格森教育咨询有限公司</td>
</tr>
<tr>
<td align="left">广州小迈网络科技有限公司</td>
</tr>
<tr>
<td align="left">北京希瑞亚斯科技有限公司</td>
</tr>
<tr>
<td align="left">欢聚时代测试公司</td>
</tr>
<tr>
<td align="left">北京蜜莱坞网络科技有限公司</td>
</tr>
</tbody></table>
<p><strong>事故发现渠道</strong>：</p>
<p>2023-03-10 17:33 发现sentry频繁报错 ，17:39群里面反馈有员工打不了卡</p>
<p><strong>事故时间线（尽量详尽）</strong>：</p>
<table>
<thead>
<tr>
<th align="left">时间</th>
<th align="left">操作 or 描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">2023-03-10 17:33</td>
<td align="left">线上sentry问题群频繁报错，研发开始介入排查</td>
</tr>
<tr>
<td align="left">2023-03-10 17:34</td>
<td align="left">发现attendance有很多模拟模算报错，包括人事接口报错</td>
</tr>
<tr>
<td align="left">2023-03-10 17:36</td>
<td align="left">clock调模拟核算接口熔断</td>
</tr>
<tr>
<td align="left">2023-03-10 17:39</td>
<td align="left">服务侧同学在群里反馈用户打不了卡，人事同学删除redis缓存</td>
</tr>
<tr>
<td align="left">2023-03-10 17:40</td>
<td align="left">有同学反馈corebase接口有问题已回滚</td>
</tr>
<tr>
<td align="left">2023-03-10 17:41</td>
<td align="left">重新刷新缓存，打卡恢复正常</td>
</tr>
<tr>
<td align="left">2023-03-10 18:10</td>
<td align="left">clock和attendance增加一个pod</td>
</tr>
</tbody></table>
<h3 id="事故修复"><a href="#事故修复" class="headerlink" title="事故修复"></a>事故修复</h3><h4 id="研发视角"><a href="#研发视角" class="headerlink" title="研发视角"></a><strong>研发视角</strong></h4><p><strong>直接原因：</strong></p>
<p>  1、attendance 服务短时间有多个模拟核算的请求超过30s，clock配置的熔断策略是超时时间30s，窗口最小请求数量20，失败阈值是50%，超时直接熔断了</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311292000480.png" alt="image2023-3-14_20-53-40" style="zoom:67%;" />



<ul>
<li><strong>间接因素：</strong>1、天九（751）在当天有很多组织调整，触发了考勤规则缓存刷新</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311292000262.png" alt="image2023-3-16_19-34-34"></p>
<p>部门变更触发刷新缓存规则的时候会刷整个租户的缓存，需要调人事接口查所有部门所有人员，接口报错，导致刷新缓存失败： </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311292001613.png" alt="image2023-3-16_19-39-46"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311292002444.png" alt="image2023-3-16_19-36-12"></p>
<p>刷新缓存失败有个逻辑，会删除租户缓存标识，查询的时候如果发现没有这个标识，会直接从db中查询，整个接口性能就会下降</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311292003240.png" alt="image2023-3-16_19-45-54"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311292003212.png" alt="image2023-3-16_19-47-0"></p>
<p>天九所有打卡员工在17:37后都直接走db查询，平均响应时间超过3s钟，当前请求量很大，影响上游attendance业务</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311292004193.png" alt="image2023-3-15_13-53-39"></p>
<p> 17:39的时候重新刷新缓存查询正常，缓存刷新成功，打卡恢复</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311292004339.png" alt="image2023-3-16_20-16-57"></p>
<p>2、attendance服务下 模拟核算接口(&#x2F;<code>clockImitateCalculate</code>)调用量突增，单个请求查基础数据并发线程40，一个请求同时需要提交6个任务，实际预期并发7个请求左右，当天天九很多员工打卡，他们前一天工作日日期、考勤规则、异常规则查询三个absence接口串行查询，整个基础数据耗时在6~7秒左右，不能及时响应打卡调用模拟核算接口的请求，请求都堆在线程中，后续请求超时导致clock熔断</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311292006696.png" alt="image2023-3-15_14-1-55"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311292006905.png" alt="image2023-3-15_14-51-28"></p>
<p>3、core-base接口返回失败的原因 :grey_question:</p>
<p>天九更新部门数据会刷新缓存，先删除缓存再更新缓存，在并发更新缓存时查询缓存可能有数据缺失，导致本次缓存更新失败（本地缓存10S有效期）进而导致人事接口查询错误。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311292009688.png" alt="image2023-3-16_22-3-2"></p>
<h4 id="测试视角"><a href="#测试视角" class="headerlink" title="测试视角"></a>测试视角</h4><p><strong>打卡链路</strong>如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311292010526.png" alt="image-20231129201013201"></p>
<h1 id="打卡信息设置"><a href="#打卡信息设置" class="headerlink" title="打卡信息设置"></a>打卡信息设置</h1></article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java</a><a class="post-meta__tags" href="/tags/SpringBoot/">SpringBoot</a></div><div class="post_share"><div class="addthis_inline_share_toolbox"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=null" async="async"></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2023/06/19/%E6%B5%85%E8%B0%88ThreadLocal%E4%B8%AD%E7%9A%84%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E9%97%AE%E9%A2%98/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/java-multiThread-threadLocal-demo.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">浅谈ThreadLocal中的内存泄漏问题</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2022/08/27/java-core-1/" title="java核心技术-基础篇"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/java-core-1.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-27</div><div class="title">java核心技术-基础篇</div></div></a></div><div><a href="/2022/08/08/leetcode-Recursion/" title="Leetcode-递归"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/leetcode.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-08</div><div class="title">Leetcode-递归</div></div></a></div><div><a href="/2022/09/13/java-core-2/" title="java核心技术-多线程"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/java-thread-lifecycle.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-13</div><div class="title">java核心技术-多线程</div></div></a></div><div><a href="/2022/09/14/java-core-3/" title="java核心技术-集合"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/java-collection-hierarchy.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-14</div><div class="title">java核心技术-集合</div></div></a></div><div><a href="/2022/12/12/SpringSecurity/" title="SpringSecurity"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/jwt.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-12</div><div class="title">SpringSecurity</div></div></a></div><div><a href="/2023/02/01/Redis-%E5%A4%8D%E4%B9%A0(1)/" title="Redis-Review"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/Redis-all.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-01</div><div class="title">Redis-Review</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/Monstercat.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">amonstercat</div><div class="author-info__description">-an amateur coder-</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">20</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">36</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">3</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/amonstercat"><i class="fas fa-cat"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://t.me/aMonstercat" target="_blank" title="Telegram"><i class="fab fa-telegram"></i></a><a class="social-icon" href="https://github.com/amonstercat" target="_blank" title="Github"><i class="fab fa-github-alt"></i></a><a class="social-icon" href="mailto:amonstercattt@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope-open-text"></i></a><a class="social-icon" href="https://twitter.com/aMonstercatt" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Having fun</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%89%93%E5%8D%A1%E4%B8%9A%E5%8A%A1%E6%80%BB%E8%A7%88"><span class="toc-number">1.</span> <span class="toc-text">打卡业务总览</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E8%AF%8D"><span class="toc-number">1.1.</span> <span class="toc-text">关键词</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8"><span class="toc-number">1.2.</span> <span class="toc-text">数据库表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">1.3.</span> <span class="toc-text">关键流程图</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%89%93%E5%8D%A1%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="toc-number">2.</span> <span class="toc-text">打卡数据同步</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%90%8C%E6%AD%A5%E4%B8%89%E6%96%B9%E6%B8%A0%E9%81%93%E6%89%93%E5%8D%A1%E6%95%B0%E6%8D%AE-exclamation"><span class="toc-number">2.1.</span> <span class="toc-text">1、同步三方渠道打卡数据:exclamation:</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1-%E8%AE%BE%E7%BD%AEjobHandler"><span class="toc-number">2.1.1.</span> <span class="toc-text">1.1 定时任务 设置jobHandler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E4%B8%BB%E5%8A%A8Pull-%E6%8B%89%E5%8F%96%E7%AC%AC%E4%B8%89%E6%96%B9%E6%B8%A0%E9%81%93"><span class="toc-number">2.1.2.</span> <span class="toc-text">1.2 主动Pull 拉取第三方渠道</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%89%E5%8F%96%E9%A3%9E%E4%B9%A6%E6%89%93%E5%8D%A1"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">拉取飞书打卡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%89%E5%8F%96%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%89%93%E5%8D%A1"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">拉取企业微信打卡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%89%E5%8F%96%E9%92%89%E9%92%89%E6%89%93%E5%8D%A1"><span class="toc-number">2.1.2.3.</span> <span class="toc-text">拉取钉钉打卡</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E6%B6%88%E8%B4%B9%E8%80%85%E6%89%B9%E9%87%8F%E6%B6%88%E8%B4%B9"><span class="toc-number">2.1.3.</span> <span class="toc-text">1.3 消费者批量消费</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%AE%9E%E6%97%B6%E6%89%93%E5%8D%A1%E2%80%94%E8%80%83%E5%8B%A4%E6%9C%BA%E5%90%8C%E6%AD%A5"><span class="toc-number">2.2.</span> <span class="toc-text">2、实时打卡—考勤机同步</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-number">2.2.1.</span> <span class="toc-text">架构图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">2.2.2.</span> <span class="toc-text">流程图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E5%AE%9E%E6%97%B6%E6%89%93%E5%8D%A1%E2%80%94Moka%E6%89%93%E5%8D%A1"><span class="toc-number">2.3.</span> <span class="toc-text">3、实时打卡—Moka打卡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%93%E5%8D%A1%E8%AE%B0%E5%BD%95%E5%85%A5%E5%BA%93-%E4%BA%8B%E5%8A%A1%E4%BF%9D%E8%AF%81Moka%E6%89%93%E5%8D%A1%E8%A1%A8%E6%95%B0%E6%8D%AE%E5%92%8C%E6%89%93%E5%8D%A1%E6%80%BB%E8%A1%A8%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">2.3.0.1.</span> <span class="toc-text">打卡记录入库(事务保证Moka打卡表数据和打卡总表数据一致性)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RPC-%E8%A7%A6%E5%8F%91%E6%89%93%E5%8D%A1%E8%80%83%E5%8B%A4%E6%A0%B8%E7%AE%97-%E5%8A%A0%E5%85%A5%E5%88%A4%E6%96%AD%E6%A0%B8%E7%AE%97%E9%99%8D%E7%BA%A7%E9%80%BB%E8%BE%91-%EF%BC%9A"><span class="toc-number">2.3.0.2.</span> <span class="toc-text">RPC 触发打卡考勤核算(加入判断核算降级逻辑)：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E6%89%93%E5%8D%A1%E6%88%90%E5%8A%9F%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5"><span class="toc-number">2.3.0.3.</span> <span class="toc-text">发送打卡成功异步通知</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%89%93%E5%8D%A1%E9%93%BE%E8%B7%AF%E4%BC%98%E5%8C%96"><span class="toc-number">3.</span> <span class="toc-text">打卡链路优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF%E4%B8%8E%E9%97%AE%E9%A2%98"><span class="toc-number">3.1.</span> <span class="toc-text">背景与问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E6%9D%A5%E6%B5%81%E7%A8%8B"><span class="toc-number">3.2.</span> <span class="toc-text">原来流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88-star2"><span class="toc-number">3.3.</span> <span class="toc-text">优化方案 :star2:</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%90%8C%E6%AD%A5%E6%89%93%E5%8D%A1%E6%B5%81%E7%A8%8B%E4%BC%98%E5%8C%96"><span class="toc-number">3.3.1.</span> <span class="toc-text">1、同步打卡流程优化 </span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%99%90%E6%B5%81%E4%BC%98%E5%8C%96"><span class="toc-number">3.3.1.1.</span> <span class="toc-text">限流优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%88%E5%B9%B6%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86%E3%80%81%E5%8A%A0%E9%94%81%E8%90%BD%E5%BA%93"><span class="toc-number">3.3.1.2.</span> <span class="toc-text">合并发送消息处理、加锁落库</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%AE%9E%E6%97%B6%E6%89%93%E5%8D%A1%E9%93%BE%E8%B7%AF%E4%BC%98%E5%8C%96"><span class="toc-number">3.3.2.</span> <span class="toc-text">2、实时打卡链路优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7"><span class="toc-number">3.3.2.1.</span> <span class="toc-text">服务降级</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%80%83%E5%8B%A4%E8%A7%84%E5%88%99%E6%8E%A5%E5%8F%A3%E7%BC%93%E5%AD%98"><span class="toc-number">3.3.2.2.</span> <span class="toc-text">考勤规则接口缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%80%83%E5%8B%A4%E8%A7%84%E5%88%99%E9%99%8D%E7%BA%A7%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.3.2.3.</span> <span class="toc-text">考勤规则降级设计</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%89%93%E5%8D%A1%E5%88%86%E8%A1%A8"><span class="toc-number">3.3.3.</span> <span class="toc-text">3、打卡分表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%93%E5%8D%A1%E6%95%85%E9%9A%9C%E5%A4%8D%E7%9B%98"><span class="toc-number">3.4.</span> <span class="toc-text">打卡故障复盘</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E6%95%85%E6%9D%A5%E9%BE%99%E5%8E%BB%E8%84%89"><span class="toc-number">3.4.1.</span> <span class="toc-text">事故来龙去脉</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E6%95%85%E4%BF%AE%E5%A4%8D"><span class="toc-number">3.4.2.</span> <span class="toc-text">事故修复</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A0%94%E5%8F%91%E8%A7%86%E8%A7%92"><span class="toc-number">3.4.2.1.</span> <span class="toc-text">研发视角</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%A7%86%E8%A7%92"><span class="toc-number">3.4.2.2.</span> <span class="toc-text">测试视角</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%89%93%E5%8D%A1%E4%BF%A1%E6%81%AF%E8%AE%BE%E7%BD%AE"><span class="toc-number">4.</span> <span class="toc-text">打卡信息设置</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/11/15/%E6%89%93%E5%8D%A1%E4%B8%9A%E5%8A%A112-21-2/" title="打卡业务串讲"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/clockOn.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="打卡业务串讲"/></a><div class="content"><a class="title" href="/2023/11/15/%E6%89%93%E5%8D%A1%E4%B8%9A%E5%8A%A112-21-2/" title="打卡业务串讲">打卡业务串讲</a><time datetime="2023-11-15T06:34:58.000Z" title="Created 2023-11-15 14:34:58">2023-11-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/19/%E6%B5%85%E8%B0%88ThreadLocal%E4%B8%AD%E7%9A%84%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E9%97%AE%E9%A2%98/" title="浅谈ThreadLocal中的内存泄漏问题"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/java-multiThread-threadLocal-demo.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="浅谈ThreadLocal中的内存泄漏问题"/></a><div class="content"><a class="title" href="/2023/06/19/%E6%B5%85%E8%B0%88ThreadLocal%E4%B8%AD%E7%9A%84%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E9%97%AE%E9%A2%98/" title="浅谈ThreadLocal中的内存泄漏问题">浅谈ThreadLocal中的内存泄漏问题</a><time datetime="2023-06-19T15:00:00.000Z" title="Created 2023-06-19 23:00:00">2023-06-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/02/01/Redis-%E5%A4%8D%E4%B9%A0(1)/" title="Redis-Review"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/Redis-all.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis-Review"/></a><div class="content"><a class="title" href="/2023/02/01/Redis-%E5%A4%8D%E4%B9%A0(1)/" title="Redis-Review">Redis-Review</a><time datetime="2023-02-01T07:00:00.000Z" title="Created 2023-02-01 15:00:00">2023-02-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/10/Rocketmq/" title="Rocketmq"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/rocketmq.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Rocketmq"/></a><div class="content"><a class="title" href="/2023/01/10/Rocketmq/" title="Rocketmq">Rocketmq</a><time datetime="2023-01-10T10:00:00.000Z" title="Created 2023-01-10 18:00:00">2023-01-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/08/SpringCloud-Gateway/" title="SpringCloud-Seata"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/seata.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SpringCloud-Seata"/></a><div class="content"><a class="title" href="/2023/01/08/SpringCloud-Gateway/" title="SpringCloud-Seata">SpringCloud-Seata</a><time datetime="2023-01-08T11:00:00.000Z" title="Created 2023-01-08 19:00:00">2023-01-08</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2024 By amonstercat</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Having fun!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="Chat"><i class="fas fa-sms"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="100" alpha="0.5" zIndex="-1" mobile="true" data-click="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>